<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è‹±ä½œæ–‡æ·»å‰Š - Yossyã®ãƒšãƒ³ã‚®ãƒ³ã•ã„ã¨</title>
  <link rel="stylesheet" href="style.css">
  <script>if(localStorage.getItem('theme')==='dark')document.documentElement.setAttribute('data-theme','dark');</script>
</head>
<body>

  <header>
    <div class="header-inner">
      <span class="logo">ğŸ§</span>
      <div>
        <h1><a href="index.html" class="site-title-link">Yossyã®ãƒšãƒ³ã‚®ãƒ³ã•ã„ã¨</a></h1>
        <p class="tagline"><a href="https://www.youtube.com/@yossy0116" target="_blank" rel="noopener noreferrer">ğŸ¥ Yossyã®ãƒšãƒ³ã‚®ãƒ³ã¡ã‚ƒã‚“ã­ã‚‹</a></p>
      </div>
    </div>
    <button class="theme-toggle" id="theme-toggle" title="ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ" aria-label="ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ">ğŸŒ™</button>
  </header>

  <nav class="site-nav">
    <ul>
      <li><a href="index.html">ğŸ  ãƒ›ãƒ¼ãƒ </a></li>
      <li><a href="about.html">ğŸ§ è‡ªå·±ç´¹ä»‹</a></li>
      <li><a href="essay.html" class="active">âœï¸ è‹±ä½œæ–‡æ·»å‰Š</a></li>
      <li><a href="contact.html">ğŸ’Œ ãŠä¾¿ã‚Š</a></li>
    </ul>
  </nav>

  <main>
    <section class="essay-section">
      <h2>ãµã¤ã†ã®è‹±ä½œæ–‡ AIæ·»å‰Š</h2>
      <p class="section-desc">å•é¡Œæ–‡ã¨è§£ç­”ã‚’å…¥åŠ›ã™ã‚‹ã¨ã€AIãŒæ–‡æ³•ãƒ»è¡¨ç¾ãƒ»æ§‹æˆã‚’æ·»å‰Šã—ã¾ã™ã€‚å›³è¡¨ã¯ï¾‘ï¾˜ã‚„ã­ã‚“ï¾œï¾˜</p>

      <div class="essay-card">
        <div class="form-group">
          <label for="question">å•é¡Œæ–‡ï¼ˆãƒ†ãƒ¼ãƒãƒ»æŒ‡ç¤ºæ–‡ï¼‰</label>
          <textarea id="question" class="essay-textarea" rows="4"
            placeholder="ä¾‹: Describe the advantages of studying abroad in about 100 words."></textarea>
        </div>

        <div class="form-group">
          <label for="answer">ã‚ãªãŸã®è§£ç­”</label>
          <textarea id="answer" class="essay-textarea essay-textarea--answer" rows="10"
            placeholder="è‹±ä½œæ–‡ã‚’ã“ã“ã«å…¥åŠ›ã—ã¦ãã ã•ã„â€¦"></textarea>
        </div>

        <div class="form-group">
          <label>è§£ç­”ä¾‹ã‚¿ã‚¤ãƒ—ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
          <div class="checkbox-group">
            <label class="checkbox-label">
              <input type="checkbox" id="type-A" name="types" value="A" checked>
              Aï¼ˆåŸæ–‡ãƒ™ãƒ¼ã‚¹ï¼‰
            </label>
            <label class="checkbox-label">
              <input type="checkbox" id="type-B" name="types" value="B">
              Bï¼ˆè‹±æ¤œ2ç´šï¼‰
            </label>
            <label class="checkbox-label">
              <input type="checkbox" id="type-C" name="types" value="C">
              Cï¼ˆè‹±æ¤œæº–1ç´šï¼‰
            </label>
            <label class="checkbox-label">
              <input type="checkbox" id="type-D" name="types" value="D">
              Dï¼ˆè‹±æ¤œ1ç´šï¼‰
            </label>
            <label class="checkbox-label">
              <input type="checkbox" id="type-E" name="types" value="E">
              Eï¼ˆåˆ¥ã‚¢ãƒ—ãƒ­ãƒ¼ãƒç‰ˆï¼‰
            </label>
          </div>
        </div>

        <div class="form-group">
          <button class="btn-collapsible" onclick="toggleCustomSection()">
            <span id="custom-toggle-text">â–¶ Fï¼šè§£ç­”ä¾‹ã‚’è©³ã—ãæŒ‡å®šã™ã‚‹</span>
          </button>
          <div id="custom-section" class="custom-section" hidden>
            <label for="custom-instruction">ã‚«ã‚¹ã‚¿ãƒ æŒ‡å®šï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</label>
            <textarea id="custom-instruction" class="essay-textarea essay-textarea--custom" rows="4"
              placeholder="ä¾‹ï¼šCEFR B1ãƒ¬ãƒ™ãƒ«ã§ã€æ—¥å¸¸çš„ãªèªå½™ã‚’ç”¨ã„ãŸè§£ç­”ä¾‹ãŒã»ã—ã„ã€‚ã¾ãŸã¯ã€ã‚ˆã‚Šå½¢å¼çš„ãªè¡¨ç¾ã‚’ä½¿ã£ãŸåˆ¥ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒã»ã—ã„ã€‚"></textarea>
          </div>
        </div>

        <button id="submit-btn" class="btn-submit" onclick="submitEssay()">âœï¸ æ·»å‰Šã™ã‚‹</button>
      </div>

      <div id="result-area" class="result-area" hidden>
        <h3 class="result-title">æ·»å‰Šçµæœï¼ˆã‚ã£ã¡ã‚ƒé•·ã„ğŸ˜‡ï¼‰</h3>
        <div id="result-content" class="result-content"></div>
      </div>
    </section>

    <section class="history-section" id="history-section" hidden>
      <div class="history-header">
        <h3 class="history-title">ğŸ“‹ éå»ã®æ·»å‰Šå±¥æ­´</h3>
        <button class="btn-hist-clear" onclick="clearAllHistory()">ã™ã¹ã¦å‰Šé™¤</button>
      </div>
      <div id="history-list" class="history-list"></div>
    </section>
  </main>

  <footer>
    <p>ğŸ§ Yossyã®ãƒšãƒ³ã‚®ãƒ³ã•ã„ã¨ &copy; Yossy</p>
  </footer>

  <script src="theme.js"></script>
  <script>
    // ===================================================
    // Cloudflare Worker ã®URLã‚’ã“ã“ã«è¨­å®šã—ã¦ãã ã•ã„
    // worker.js ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸå¾Œã€URLã‚’å·®ã—æ›¿ãˆã¦ãã ã•ã„
    // ===================================================
    const WORKER_URL = 'https://essay-proxy.yoshida-tom-ac.workers.dev';
    const TYPES_KEY = 'essay_types_selection';
    const CUSTOM_KEY = 'essay_custom_instruction';

    // localStorage ã«ä¿å­˜ã•ã‚ŒãŸã‚¿ã‚¤ãƒ—ã‚’å¾©å…ƒ
    function loadSavedTypes() {
      try {
        const saved = localStorage.getItem(TYPES_KEY);
        return saved ? JSON.parse(saved) : ['A'];
      } catch {
        return ['A'];
      }
    }

    // ã‚¿ã‚¤ãƒ—é¸æŠã‚’ä¿å­˜
    function saveSelectedTypes() {
      const checkboxes = document.querySelectorAll('input[name="types"]:checked');
      const types = Array.from(checkboxes).map(cb => cb.value);
      if (types.length === 0) {
        // ä½•ã‚‚é¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆã¯ A ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«
        localStorage.setItem(TYPES_KEY, JSON.stringify(['A']));
        document.getElementById('type-A').checked = true;
      } else {
        localStorage.setItem(TYPES_KEY, JSON.stringify(types));
      }
    }

    // åˆæœŸåŒ–ï¼šä¿å­˜ã•ã‚ŒãŸã‚¿ã‚¤ãƒ—ã‚’å¾©å…ƒ
    function restoreTypes() {
      const saved = loadSavedTypes();
      document.querySelectorAll('input[name="types"]').forEach(cb => {
        cb.checked = saved.includes(cb.value);
      });
    }

    // ä¿å­˜ã•ã‚ŒãŸ custom instruction ã‚’å¾©å…ƒ
    function loadCustomInstruction() {
      try {
        return localStorage.getItem(CUSTOM_KEY) || '';
      } catch {
        return '';
      }
    }

    // Custom instruction ã‚’ä¿å­˜
    function saveCustomInstruction() {
      const text = document.getElementById('custom-instruction').value.trim();
      localStorage.setItem(CUSTOM_KEY, text);
    }

    // Custom section ã‚’å±•é–‹/æŠ˜ç•³
    function toggleCustomSection() {
      const section = document.getElementById('custom-section');
      const toggleText = document.getElementById('custom-toggle-text');
      section.hidden = !section.hidden;
      toggleText.textContent = section.hidden ? 'â–¶ Fï¼šè§£ç­”ä¾‹ã‚’è©³ã—ãæŒ‡å®šã™ã‚‹' : 'â–¼ Fï¼šè§£ç­”ä¾‹ã‚’è©³ã—ãæŒ‡å®šã™ã‚‹';
    }

    // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹å¤‰æ›´æ™‚ã«è‡ªå‹•ä¿å­˜
    document.addEventListener('DOMContentLoaded', function() {
      restoreTypes();
      document.querySelectorAll('input[name="types"]').forEach(cb => {
        cb.addEventListener('change', saveSelectedTypes);
      });
      // Custom instruction ã®å¾©å…ƒ
      document.getElementById('custom-instruction').value = loadCustomInstruction();
      document.getElementById('custom-instruction').addEventListener('change', saveCustomInstruction);
      document.getElementById('custom-instruction').addEventListener('blur', saveCustomInstruction);
    });

    async function submitEssay() {
      const question = document.getElementById('question').value.trim();
      const answer   = document.getElementById('answer').value.trim();

      if (!answer) {
        alert('è§£ç­”ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
      }

      if (WORKER_URL.includes('YOUR_WORKER_NAME')) {
        alert('å…ˆç”ŸãŒã¾ã æ·»å‰Šæ©Ÿèƒ½ã®è¨­å®šã‚’å®Œäº†ã—ã¦ã„ã¾ã›ã‚“ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚');
        return;
      }

      const btn = document.getElementById('submit-btn');
      btn.disabled = true;
      btn.textContent = 'æ·»å‰Šä¸­â€¦';

      const resultArea    = document.getElementById('result-area');
      const resultContent = document.getElementById('result-content');
      resultContent.innerHTML = '';
      resultArea.hidden = false;
      resultArea.scrollIntoView({ behavior: 'smooth' });

      try {
        // é¸æŠã•ã‚ŒãŸã‚¿ã‚¤ãƒ—ã¨ custom instruction ã‚’å–å¾—
        const checkboxes = document.querySelectorAll('input[name="types"]:checked');
        const types = Array.from(checkboxes).map(cb => cb.value);
        const customInstruction = document.getElementById('custom-instruction').value.trim();

        console.log('[Essay] Sending request with types:', types, 'customInstruction:', customInstruction);

        const res = await fetch(WORKER_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ question, answer, types, customInstruction }),
        });

        console.log('[Essay] Response status:', res.status, 'Content-Type:', res.headers.get('content-type'));

        if (!res.ok) {
          const msg = await res.text();
          console.error('[Essay] Error response:', msg);
          throw new Error(`ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ (${res.status}): ${msg}`);
        }

        // SSE ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’é€æ¬¡èª­ã¿å–ã‚Šã€ãƒ†ã‚­ã‚¹ãƒˆãŒå±ŠããŸã³ã«æç”»ã™ã‚‹
        const reader  = res.body.getReader();
        const decoder = new TextDecoder();
        let buffer   = '';
        let fullText = '';
        let eventCount = 0;

        while (true) {
          const { done, value } = await reader.read();
          if (done) {
            console.log('[Essay] Stream complete. Total events:', eventCount, 'Text length:', fullText.length);
            break;
          }

          buffer += decoder.decode(value, { stream: true });
          const lines = buffer.split('\n');
          buffer = lines.pop(); // æœ€å¾Œã®ä¸å®Œå…¨ãªè¡Œã¯æ¬¡å›ã«æŒã¡è¶Šã™

          for (const line of lines) {
            if (!line.startsWith('data: ')) continue;
            const raw = line.slice(6).trim();
            if (!raw) continue;
            try {
              const evt = JSON.parse(raw);
              console.log('[Essay] Event type:', evt.type);
              if (evt.type === 'content_block_delta' && evt.delta?.type === 'text_delta') {
                fullText += evt.delta.text;
                eventCount++;
                resultContent.innerHTML = renderMarkdown(fullText);
              } else if (evt.type === 'message_start' || evt.type === 'message_stop' || evt.type === 'content_block_start') {
                console.log('[Essay] Metadata event:', evt.type);
              }
            } catch (parseErr) {
              console.warn('[Essay] JSON parse error:', raw.slice(0, 100), parseErr.message);
            }
          }
        }

        if (!fullText) {
          resultContent.innerHTML = '<p>ã‚¨ãƒ©ãƒ¼ï¼šã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æ·»å‰Šçµæœã‚’å—ã‘å–ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>';
          console.error('[Essay] No text received. Check Worker logs and API response.');
        } else {
          saveToHistory(question, answer, fullText);
        }

      } catch (err) {
        resultArea.hidden = true;
        console.error('[Essay] Exception:', err);
        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:\n' + err.message + '\n\nãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ï¼ˆF12ï¼‰ã§è©³ç´°ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
      } finally {
        btn.disabled = false;
        btn.textContent = 'âœï¸ æ·»å‰Šã™ã‚‹';
      }
    }

    function escapeHtml(s) {
      return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    function formatInline(s) {
      return s
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/`(.+?)`/g, '<code>$1</code>');
    }

    function renderMarkdown(text) {
      if (typeof text !== 'string') return '<p>ï¼ˆæ·»å‰Šçµæœã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸï¼‰</p>';
      const lines = text.split('\n');
      let html   = '';
      let inList = false;

      for (const line of lines) {
        if (line.startsWith('## ')) {
          if (inList) { html += '</ul>'; inList = false; }
          html += `<h3 class="r-h3">${formatInline(escapeHtml(line.slice(3)))}</h3>`;
        } else if (line.startsWith('### ')) {
          if (inList) { html += '</ul>'; inList = false; }
          html += `<h4 class="r-h4">${formatInline(escapeHtml(line.slice(4)))}</h4>`;
        } else if (/^[-*] /.test(line)) {
          if (!inList) { html += '<ul class="r-list">'; inList = true; }
          html += `<li>${formatInline(escapeHtml(line.slice(2)))}</li>`;
        } else if (line.trim() === '') {
          if (inList) { html += '</ul>'; inList = false; }
        } else {
          if (inList) { html += '</ul>'; inList = false; }
          html += `<p class="r-p">${formatInline(escapeHtml(line))}</p>`;
        }
      }

      if (inList) html += '</ul>';
      return html;
    }

    // ===================================================
    // æ·»å‰Šå±¥æ­´ (localStorage)
    // ===================================================
    const HIST_KEY = 'essay_history';
    const MAX_HIST = 20;

    function loadHistories() {
      try { return JSON.parse(localStorage.getItem(HIST_KEY)) || []; }
      catch { return []; }
    }

    function saveToHistory(question, answer, correction) {
      const list = loadHistories();
      list.unshift({ id: Date.now(), date: new Date().toISOString(), question, answer, correction });
      if (list.length > MAX_HIST) list.length = MAX_HIST;
      localStorage.setItem(HIST_KEY, JSON.stringify(list));
      renderHistoryList();
    }

    function renderHistoryList() {
      const list = loadHistories();
      const section = document.getElementById('history-section');
      const container = document.getElementById('history-list');
      if (list.length === 0) { section.hidden = true; return; }
      section.hidden = false;
      container.innerHTML = list.map(h => {
        const d = new Date(h.date);
        const pad = n => String(n).padStart(2, '0');
        const dateStr = `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
        const qPrev = h.question ? escapeHtml(h.question.slice(0, 45)) + (h.question.length > 45 ? 'â€¦' : '') : 'ï¼ˆå•é¡Œæ–‡ãªã—ï¼‰';
        return `
          <div class="history-item" id="hist-${h.id}">
            <div class="history-item-row">
              <div class="history-item-meta">
                <span class="history-date">${dateStr}</span>
                <span class="history-preview">${qPrev}</span>
              </div>
              <div class="history-item-actions">
                <button class="btn-hist-view" onclick="toggleHistoryItem(${h.id})">è¡¨ç¤º</button>
                <button class="btn-hist-del" onclick="deleteHistoryItem(${h.id})">å‰Šé™¤</button>
              </div>
            </div>
            <div class="history-item-body" id="hist-body-${h.id}" hidden>
              <p class="history-answer-preview"><strong>è§£ç­”ï¼š</strong>${escapeHtml(h.answer.slice(0, 80))}${h.answer.length > 80 ? 'â€¦' : ''}</p>
              <div class="result-content">${renderMarkdown(h.correction)}</div>
            </div>
          </div>`;
      }).join('');
    }

    function toggleHistoryItem(id) {
      const body = document.getElementById(`hist-body-${id}`);
      const btn  = document.querySelector(`#hist-${id} .btn-hist-view`);
      body.hidden = !body.hidden;
      btn.textContent = body.hidden ? 'è¡¨ç¤º' : 'é–‰ã˜ã‚‹';
    }

    function deleteHistoryItem(id) {
      const list = loadHistories().filter(h => h.id !== id);
      localStorage.setItem(HIST_KEY, JSON.stringify(list));
      renderHistoryList();
    }

    function clearAllHistory() {
      if (!confirm('ã™ã¹ã¦ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
      localStorage.removeItem(HIST_KEY);
      renderHistoryList();
    }

    // åˆæœŸæç”»
    renderHistoryList();
  </script>

</body>
</html>
