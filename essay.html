<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è‹±ä½œæ–‡æ·»å‰Š - Yossyã®ãƒšãƒ³ã‚®ãƒ³ã•ã„ã¨</title>
  <meta name="description" content="AIæ·»å‰Šæ©Ÿèƒ½ã‚’ä½¿ã£ã¦è‹±ä½œæ–‡ã‚’æ”¹å–„ã€‚ã‚ãªãŸã®è‹±ä½œæ–‡ã‚’ãƒ†ãƒ¼ãƒã‚„æŒ‡ç¤ºæ–‡ã«æ²¿ã‚ã›ã¦æ·»å‰Šã—ã¾ã™ã€‚">
  <meta name="author" content="Yossy">
  <meta name="theme-color" content="#1a2e44">

  <!-- OGP -->
  <meta property="og:title" content="è‹±ä½œæ–‡æ·»å‰Š - Yossyã®ãƒšãƒ³ã‚®ãƒ³ã•ã„ã¨">
  <meta property="og:description" content="AIæ·»å‰Šæ©Ÿèƒ½ã‚’ä½¿ã£ã¦è‹±ä½œæ–‡ã‚’æ”¹å–„ã€‚è©³ã—ã„è§£èª¬ä»˜ãã§å­¦ç¿’ã§ãã¾ã™ã€‚">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://yossy-ac.github.io/YossyHP/essay.html">
  <meta property="og:image" content="https://yossy-ac.github.io/YossyHP/og-image.svg">

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="è‹±ä½œæ–‡æ·»å‰Š - Yossyã®ãƒšãƒ³ã‚®ãƒ³ã•ã„ã¨">
  <meta name="twitter:description" content="AIæ·»å‰Šã§è‹±ä½œæ–‡ã‚’æ”¹å–„ã€‚è©³ã—ã„è§£èª¬ä»˜ãã€‚">
  <meta name="twitter:image" content="https://yossy-ac.github.io/YossyHP/og-image.svg">

  <link rel="stylesheet" href="style.css">
  <script>if(localStorage.getItem('theme')==='dark')document.documentElement.setAttribute('data-theme','dark');</script>
  <style>
    /* ===== 3ã‚¹ãƒ†ãƒƒãƒ—UIç”¨ã‚¹ã‚¿ã‚¤ãƒ« ===== */
    .essay-section { max-width: 800px; margin: 0 auto; padding: 2rem 0; }
    .hidden { display: none !important; }
    .step-container { display: none; padding: 2rem; border: 1px solid var(--color-border, #ccc); border-radius: 8px; margin: 2rem 0; background: var(--color-surface, #fafafa); overflow: hidden; }
    .step-container.active { display: block; }
    .step-header { margin-bottom: 2rem; }
    .step-number { font-size: 0.9rem; color: var(--color-text-muted, #666); }
    .step-title { font-size: 1.5rem; margin: 0.5rem 0 0 0; color: var(--color-text, #333); }

    .input-mode-tabs { display: flex; gap: 0.5rem; margin: 1.5rem 0; }
    .mode-btn { padding: 0.5rem 1rem; border: 2px solid var(--color-border, #ddd); background: var(--color-surface, white); border-radius: 4px; cursor: pointer; transition: all 0.2s; color: var(--color-text, #333); }
    .mode-btn.active { border-color: #007bff; background: #e7f3ff; color: #007bff; font-weight: bold; }
    .mode-btn:hover { border-color: #0056b3; }

    .btn-clear-history { background: #dc3545; color: white; padding: 0.5rem 1rem; font-size: 0.9rem; border: none; border-radius: 4px; cursor: pointer; font-weight: 500; }

    .input-mode { display: none; margin: 1.5rem 0; }
    .input-mode.active { display: block; }

    .image-upload-area { padding: 2rem; border: 2px dashed var(--color-border, #ddd); border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.2s; background: var(--color-surface, #f9f9f9); color: var(--color-text, #333); }
    .image-upload-area:hover { border-color: #007bff; background: #f0f8ff; }
    .image-upload-area.drag-over { border-color: #28a745; background: #f0fff4; }

    .upload-placeholder { pointer-events: none; }
    .upload-placeholder p { margin: 0.5rem 0; color: var(--color-text, #333); }
    .upload-placeholder .upload-hint { font-size: 0.9rem; color: var(--color-text-muted, #666); }

    .image-preview { padding: 1rem; }
    .image-preview-item { position: relative; display: inline-block; }
    .image-preview-item img { max-width: 300px; max-height: 200px; border-radius: 4px; border: 1px solid var(--color-border, #ddd); }
    .image-preview-name { margin: 0.5rem 0 0 0; font-size: 0.9rem; color: var(--color-text-muted, #666); }
    .btn-remove-image { margin-top: 0.5rem; padding: 0.3rem 0.6rem; font-size: 0.85rem; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer; }
    .btn-remove-image:hover { background: #c82333; }

    .ocr-result-display { margin: 1.5rem -2rem; padding: 1.25rem 0; background: var(--color-bg, #f0f4f8); border-top: 3px solid var(--color-accent, #2563eb); border-radius: 0; }
    .ocr-result-display h3 { margin: 0 0 0.75rem 0; font-size: 1rem; padding: 0 1rem; }
    .ocr-result-display textarea { width: 100%; min-height: 400px; padding: 0.75rem 1rem; border: none; border-top: 1px solid var(--color-border, #e2e8f0); border-bottom: 1px solid var(--color-border, #e2e8f0); border-radius: 0; font-family: monospace; font-size: 0.9rem; resize: vertical; box-sizing: border-box; -webkit-overflow-scrolling: touch; background: var(--color-surface, #fff); color: var(--color-text, #1e293b); }
    .ocr-result-display p.note { margin: 0.5rem 0 0 0; font-size: 0.85rem; color: var(--color-text-sub, #666); padding: 0 1rem; }
    @media (max-width: 600px) {
      .ocr-result-display textarea { min-height: 60vh; font-size: 14px; padding: 0.75rem; }
    }

    /* OCRãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
    .ocr-loading { display: none; margin: 1.5rem 0; padding: 1.5rem; text-align: center; background: var(--color-surface, #fff); border: 1px solid var(--color-border-light, #ddd); border-radius: 8px; }
    .ocr-loading.active { display: block; }
    .ocr-loading-spinner { display: inline-block; width: 28px; height: 28px; border: 3px solid var(--color-border-light, #ddd); border-top-color: #007bff; border-radius: 50%; animation: ocr-spin 0.8s linear infinite; }
    @keyframes ocr-spin { to { transform: rotate(360deg); } }
    .ocr-loading-text { margin-top: 0.75rem; font-size: 0.9rem; color: var(--color-text-sub, #666); }

    .form-group { margin: 1.5rem 0; }
    .form-group label { display: block; font-weight: bold; margin: 0 0 0.5rem 0; color: var(--color-text, #333); }
    .essay-textarea { width: 100%; padding: 0.75rem; border: 1px solid var(--color-border, #ddd); border-radius: 4px; font-family: monospace; font-size: 0.95rem; resize: vertical; min-height: 200px; background: var(--color-surface, white); color: var(--color-text, #333); }
    .essay-textarea:focus { outline: none; border-color: #007bff; box-shadow: 0 0 0 3px rgba(0,123,255,0.1); }
    @media (max-width: 600px) {
      .essay-textarea { min-height: 280px; font-size: 16px; }
      .ocr-result-display textarea { min-height: 60vh; font-size: 14px; -webkit-overflow-scrolling: touch; }
    }

    /* å•é¡Œã‚¿ã‚¤ãƒ—é¸æŠ */
    .essay-type-tabs { display: flex; gap: 0.5rem; margin: 1.5rem 0; flex-wrap: wrap; }
    .type-tab { padding: 0.75rem 1.5rem; border: 2px solid var(--color-border, #ddd); background: var(--color-surface, white); border-radius: 6px; cursor: pointer; font-weight: 500; transition: all 0.2s; color: var(--color-text, #333); }
    .type-tab:hover { border-color: #007bff; background: #f0f8ff; }
    .type-tab.active { border-color: #007bff; background: #007bff; color: white; }

    .essay-options { display: none; margin: 1.5rem 0; padding: 1.5rem; background: var(--color-surface, #f9f9f9); border-radius: 6px; }
    .essay-options.active { display: block; }

    .level-checkboxes { display: flex; flex-wrap: wrap; gap: 1.5rem; margin: 1rem 0; }
    .level-checkboxes label { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-weight: normal; }
    .level-checkboxes input[type="checkbox"] { cursor: pointer; }

    .hint { margin: 1rem 0; padding: 0.75rem; background: rgba(0,123,255,0.1); border-left: 3px solid #007bff; border-radius: 3px; font-size: 0.95rem; color: #0056b3; }

    .step-actions { display: flex; gap: 1rem; margin: 2rem 0; justify-content: space-between; }
    .btn-action { padding: 0.75rem 1.5rem; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 1rem; transition: all 0.2s; }
    .btn-back { background: #6c757d; color: white; }
    .btn-back:hover { background: #5a6268; }
    .btn-next { background: #007bff; color: white; }
    .btn-next:hover { background: #0056b3; }
    .btn-submit { background: #28a745; color: white; }
    .btn-submit:hover { background: #218838; }
    .btn-submit:disabled { background: #ccc; cursor: not-allowed; }

    .result-area { margin: 2rem 0; padding: 2rem; background: var(--color-surface, #f9f9f9); border-radius: 8px; border: 1px solid var(--color-border, #ddd); }
    .result-area h3 { margin-top: 0; }
    .result-content { line-height: 1.8; }
    .r-h3 { font-size: 1.2rem; margin: 1.5rem 0 1rem 0; font-weight: bold; }
    .r-h4 { font-size: 1.05rem; margin: 1rem 0 0.75rem 0; font-weight: bold; }
    .r-p { margin: 0.75rem 0; }
    .r-list { margin: 0.75rem 0 0.75rem 1.5rem; padding: 0; }
    .r-list li { margin: 0.3rem 0; }

    @media (max-width: 768px) {
      .step-container { padding: 1.5rem; }
      .essay-type-tabs { flex-direction: column; }
      .type-tab { width: 100%; }
      .step-actions { flex-direction: column; }
      .btn-action { width: 100%; }
      .level-checkboxes { flex-direction: column; gap: 0.75rem; }
      .ocr-result-display { margin-left: -1.5rem; margin-right: -1.5rem; padding-left: 0; padding-right: 0; }
    }

    /* ===== èªæ•°ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ ===== */
    .word-count { font-size: 0.85rem; color: var(--color-text-muted, #888); text-align: right; margin-top: 0.3rem; }

    /* ===== ä¸‹æ›¸ãä¿å­˜ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ ===== */
    .draft-indicator { font-size: 0.8rem; color: var(--color-text-muted, #888); margin-top: 0.2rem; min-height: 1.2em; }

    /* ===== çµæœæ“ä½œãƒœã‚¿ãƒ³ ===== */
    .result-actions { display: flex; gap: 0.75rem; margin: 0 0 1rem 0; flex-wrap: wrap; }
    .btn-icon-action { padding: 0.5rem 1rem; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; font-weight: 500; transition: all 0.2s; }
    .btn-copy { background: #17a2b8; color: white; }
    .btn-copy:hover { background: #138496; }
    .btn-print { background: #6c757d; color: white; }
    .btn-print:hover { background: #5a6268; }
    .btn-cancel-stream { background: #dc3545; color: white; }
    .btn-cancel-stream:hover { background: #c82333; }

    /* ===== ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰ ===== */
    .usage-guide { margin: 0.5rem 0 1.5rem 0; }
    .usage-guide > summary { cursor: pointer; padding: 0.7rem 1rem; background: rgba(0,123,255,0.07); border: 1px solid rgba(0,123,255,0.2); border-radius: 6px; color: #007bff; font-weight: 600; list-style: none; display: flex; align-items: center; gap: 0.5rem; }
    .usage-guide > summary::-webkit-details-marker { display: none; }
    .usage-guide > summary::before { content: 'â–¶'; font-size: 0.7em; transition: transform 0.2s; }
    .usage-guide[open] > summary::before { transform: rotate(90deg); }
    .usage-guide-content { padding: 1.2rem 1.4rem; background: var(--color-surface, #f9f9f9); border: 1px solid var(--color-border, #ddd); border-top: none; border-radius: 0 0 6px 6px; font-size: 0.92rem; }
    .usage-guide-content ol, .usage-guide-content ul { margin: 0.4rem 0 0.4rem 1.3rem; padding: 0; }
    .usage-guide-content li { margin: 0.35rem 0; }
  </style>
</head>
<body>

  <header>
    <div class="header-inner">
      <span class="logo">ğŸ§</span>
      <div>
        <h1><a href="index.html" class="site-title-link">Yossyã®ãƒšãƒ³ã‚®ãƒ³ã•ã„ã¨</a></h1>
        <p class="tagline"><a href="https://www.youtube.com/@yossy0116" target="_blank" rel="noopener noreferrer">ğŸ¥ Yossyã®ãƒšãƒ³ã‚®ãƒ³ã¡ã‚ƒã‚“ã­ã‚‹</a></p>
      </div>
    </div>
    <button class="theme-toggle" id="theme-toggle" title="ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ" aria-label="ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ">ğŸŒ™</button>
  </header>

  <nav class="site-nav">
    <ul>
      <li><a href="index.html">ğŸ  ãƒ›ãƒ¼ãƒ </a></li>
      <li><a href="about.html">ğŸ§ è‡ªå·±ç´¹ä»‹</a></li>
      <li><a href="essay.html" class="active">âœï¸ è‹±ä½œæ–‡æ·»å‰Š</a></li>
      <li><a href="contact.html">ğŸ“ ãŠä¾¿ã‚Š</a></li>
      <li><a href="files-download.html">ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</a></li>
    </ul>
  </nav>

  <main>
    <section class="essay-section">
      <h2>è‹±ä½œæ–‡ AIæ·»å‰Š</h2>
      <p class="section-desc">æ·»å‰Šã®ã€Œèªæ•°ã€ã¯ä¿¡ã˜ãŸã‚‰ã‚ã‹ã‚“ï¾ƒï¾ ã€Œï½ã¯å¿…é ˆï¼ã€ã‚‚ä¿¡ã˜ã¦ã„ã„ã‹ã‚ã‹ã‚‰ã‚“ï¾ƒï¾</p>

      <!-- ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰ -->
      <details class="usage-guide">
        <summary>ğŸ“– ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰</summary>
        <div class="usage-guide-content">
          <ol>
            <li><strong>å•é¡Œæ–‡ã‚’å…¥åŠ›</strong>ï¼ˆæ‰‹å…¥åŠ› or ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰â†’OCRï¼‰</li>
            <li><strong>ã‚ãªãŸã®è§£ç­”ã‚’å…¥åŠ›</strong>ï¼ˆåŒä¸Šï¼‰ã€‚èªæ•°ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã§æ–‡å­—æ•°ç¢ºèª</li>
            <li><strong>å•é¡Œã‚¿ã‚¤ãƒ—ã¨ãƒ¬ãƒ™ãƒ«ã‚’é¸æŠ</strong>ã—ã¦ã€Œæ·»å‰Šã‚’å®Ÿè¡Œã€</li>
          </ol>
          <p style="margin: 0.7rem 0 0.3rem;"><strong>ğŸ’¡ ãƒ’ãƒ³ãƒˆ</strong></p>
          <ul>
            <li>ä¸‹æ›¸ãã¯è‡ªå‹•ä¿å­˜ã•ã‚Œã¾ã™ï¼ˆãƒšãƒ¼ã‚¸ã‚’é›¢ã‚Œã¦ã‚‚å¾©å…ƒï¼‰</li>
            <li>æ·»å‰Šçµæœã¯ğŸ“‹ã‚³ãƒ”ãƒ¼ãƒ»ğŸ–¨ï¸å°åˆ·ãŒã§ãã¾ã™</li>
            <li>å‡¦ç†ä¸­ã«â¹ä¸­æ–­ãƒœã‚¿ãƒ³ã§é€”ä¸­åœæ­¢ã§ãã¾ã™</li>
            <li>ãƒ¬ãƒ™ãƒ«ã‚’è¤‡æ•°é¸ã¶ã»ã©å‡¦ç†æ™‚é–“ãŒé•·ããªã‚Šã¾ã™</li>
            <li>æ·»å‰Šã®ã€Œèªæ•°ã‚«ã‚¦ãƒ³ãƒˆã€ã¨ã€Œï½ã¯å¿…é ˆã€ã®æŒ‡æ‘˜ã¯å‚è€ƒç¨‹åº¦ã«</li>
          </ul>
        </div>
      </details>

      <!-- ===== ã‚¹ãƒ†ãƒƒãƒ—1: å•é¡Œæ–‡å…¥åŠ› ===== -->


      <!-- ===== ã‚¹ãƒ†ãƒƒãƒ—1: å•é¡Œæ–‡å…¥åŠ› ===== -->
      <div id="step-1" class="step-container active">
        <div class="step-header">
          <div class="step-number">ã‚¹ãƒ†ãƒƒãƒ— 1 / 3</div>
          <h3 class="step-title">ğŸ“ å•é¡Œæ–‡ã®å…¥åŠ›</h3>
        </div>

        <div class="form-group">
          <label>å…¥åŠ›æ–¹æ³•</label>
          <div class="input-mode-tabs">
            <button class="mode-btn active" data-mode="text" data-field="question" onclick="switchInputMode(event)">âœ‹ æ‰‹å…¥åŠ›</button>
            <button class="mode-btn" data-mode="image" data-field="question" onclick="switchInputMode(event)">ğŸ“¸ ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
          </div>
        </div>

        <!-- æ‰‹å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ -->
        <div id="question-text-mode" class="input-mode active">
          <div class="form-group">
            <label for="question-text-input">å•é¡Œæ–‡ã‚’å…¥åŠ›</label>
            <textarea id="question-text-input" class="essay-textarea" rows="6" placeholder="ä¾‹: Describe the advantages of studying abroad in about 100 words."></textarea>
          </div>
        </div>

        <!-- ç”»åƒãƒ¢ãƒ¼ãƒ‰ -->
        <div id="question-image-mode" class="input-mode">
          <div class="form-group">
            <label>å•é¡Œæ–‡ã®ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</label>
            <div class="image-upload-area" id="question-upload-area" onclick="triggerFileInput('question')" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
              <input type="file" id="question-image-input" accept="image/jpeg,image/png,image/gif,image/webp" onchange="handleImageUpload(event, 'question')" class="hidden">
              <div class="upload-placeholder">
                <p>ğŸ“¸ ã‚¿ãƒƒãƒ—ã—ã¦ç”»åƒã‚’é¸æŠ</p>
                <p class="upload-hint">ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</p>
                <p class="upload-hint">å¯¾å¿œå½¢å¼: JPEG, PNG, GIF, WebP</p>
              </div>
              <div id="question-image-preview" class="image-preview" class="hidden"></div>
            </div>
            <div style="margin-top: 1rem;">
              <button class="btn-action btn-next" onclick="document.getElementById('question-image-input').click()">ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</button>
            </div>
            <div id="question-ocr-loading" class="ocr-loading">
              <div class="ocr-loading-spinner"></div>
              <p class="ocr-loading-text">ç”»åƒã‚’èª­ã¿å–ã£ã¦ã„ã¾ã™â€¦</p>
            </div>
            <div id="question-ocr-display" class="hidden">
              <div class="ocr-result-display">
                <h3>ğŸ“‹ OCRèª­ã¿å–ã‚Šçµæœï¼ˆä¿®æ­£ã—ã¦ãã ã•ã„ï¼‰</h3>
                <textarea id="question-ocr-text" class="essay-textarea" rows="6"></textarea>
                <p class="note">â€» ä¸æ­£ç¢ºãªéƒ¨åˆ†ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„</p>
              </div>
            </div>
          </div>
        </div>

        <div class="step-actions">
          <button class="btn-action btn-next" onclick="goToStep(2)">æ¬¡ã¸ â†’</button>
        </div>
      </div>

      <!-- ===== ã‚¹ãƒ†ãƒƒãƒ—2: è§£ç­”å…¥åŠ› ===== -->
      <div id="step-2" class="step-container">
        <div class="step-header">
          <div class="step-number">ã‚¹ãƒ†ãƒƒãƒ— 2 / 3</div>
          <h3 class="step-title">âœï¸ ã‚ãªãŸã®è§£ç­”</h3>
        </div>

        <div class="form-group">
          <label>å…¥åŠ›æ–¹æ³•</label>
          <div class="input-mode-tabs">
            <button class="mode-btn active" data-mode="text" data-field="answer" onclick="switchInputMode(event)">âœ‹ æ‰‹å…¥åŠ›</button>
            <button class="mode-btn" data-mode="image" data-field="answer" onclick="switchInputMode(event)">ğŸ“¸ ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
          </div>
        </div>

        <!-- æ‰‹å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ -->
        <div id="answer-text-mode" class="input-mode active">
          <div class="form-group">
            <label for="answer-text-input">è§£ç­”ã‚’å…¥åŠ›</label>
            <textarea id="answer-text-input" class="essay-textarea" rows="10" placeholder="è‹±ä½œæ–‡ï¼ˆã¾ãŸã¯ã‚ãªãŸã®è‹±è¨³ï¼‰ã‚’ã“ã“ã«å…¥åŠ›ã—ã¦ãã ã•ã„â€¦"></textarea>
            <div id="word-count-display" class="word-count">èªæ•°: 0èª</div>
            <div id="draft-indicator" class="draft-indicator"></div>
          </div>
        </div>

        <!-- ç”»åƒãƒ¢ãƒ¼ãƒ‰ -->
        <div id="answer-image-mode" class="input-mode">
          <div class="form-group">
            <label>è§£ç­”ã®ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</label>
            <div class="image-upload-area" id="answer-upload-area" onclick="triggerFileInput('answer')" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
              <input type="file" id="answer-image-input" accept="image/jpeg,image/png,image/gif,image/webp" onchange="handleImageUpload(event, 'answer')" class="hidden">
              <div class="upload-placeholder">
                <p>ğŸ“¸ ã‚¿ãƒƒãƒ—ã—ã¦ç”»åƒã‚’é¸æŠ</p>
                <p class="upload-hint">ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</p>
                <p class="upload-hint">å¯¾å¿œå½¢å¼: JPEG, PNG, GIF, WebP</p>
              </div>
              <div id="answer-image-preview" class="image-preview" class="hidden"></div>
            </div>
            <div style="margin-top: 1rem;">
              <button class="btn-action btn-next" onclick="document.getElementById('answer-image-input').click()">ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</button>
            </div>
            <div id="answer-ocr-loading" class="ocr-loading">
              <div class="ocr-loading-spinner"></div>
              <p class="ocr-loading-text">ç”»åƒã‚’èª­ã¿å–ã£ã¦ã„ã¾ã™â€¦</p>
            </div>
            <div id="answer-ocr-display" class="hidden">
              <div class="ocr-result-display">
                <h3>ğŸ“‹ OCRèª­ã¿å–ã‚Šçµæœï¼ˆä¿®æ­£ã—ã¦ãã ã•ã„ï¼‰</h3>
                <textarea id="answer-ocr-text" class="essay-textarea" rows="10"></textarea>
                <p class="note">â€» ä¸æ­£ç¢ºãªéƒ¨åˆ†ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„</p>
              </div>
            </div>
          </div>
        </div>

        <div class="step-actions">
          <button class="btn-action btn-back" onclick="goToStep(1)">â† æˆ»ã‚‹</button>
          <button class="btn-action btn-next" onclick="goToStep(3)">æ¬¡ã¸ â†’</button>
        </div>
      </div>

      <!-- ===== ã‚¹ãƒ†ãƒƒãƒ—3: å•é¡Œã‚¿ã‚¤ãƒ—é¸æŠ ===== -->
      <div id="step-3" class="step-container">
        <div class="step-header">
          <div class="step-number">ã‚¹ãƒ†ãƒƒãƒ— 3 / 3</div>
          <h3 class="step-title">ğŸ¯ å•é¡Œã‚¿ã‚¤ãƒ—ã‚’é¸æŠ</h3>
        </div>

        <div class="form-group">
          <label>ã‚ãªãŸã®å•é¡Œã¯ã©ã‚Œã§ã™ã‹ï¼Ÿ</label>
          <div class="essay-type-tabs">
            <button class="type-tab active" data-type="free-essay" onclick="selectEssayType(event)">ğŸ“ è‡ªç”±è‹±ä½œæ–‡</button>
            <button class="type-tab" data-type="translation" onclick="selectEssayType(event)">ğŸ”„ å’Œæ–‡è‹±è¨³</button>
            <button class="type-tab" data-type="diagram-essay" onclick="selectEssayType(event)">ğŸ“Š å›³è¡¨ä»˜ãè‹±ä½œæ–‡</button>
          </div>
        </div>
        <!-- è‡ªç”±è‹±ä½œæ–‡ã‚ªãƒ—ã‚·ãƒ§ãƒ³ -->
        <div id="options-free-essay" class="essay-options active">
          <h3>ğŸ“š è§£ç­”ä¾‹ã®ãƒ¬ãƒ™ãƒ«ã‚’é¸æŠï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</h3>
          <div class="level-checkboxes">
            <label><input type="checkbox" name="level" value="A" checked> Aï¼ˆåŸæ–‡ãƒ™ãƒ¼ã‚¹ï¼‰</label>
            <label><input type="checkbox" name="level" value="B"> Bï¼ˆè‹±æ¤œ2ç´šï¼‰</label>
            <label><input type="checkbox" name="level" value="C"> Cï¼ˆè‹±æ¤œæº–1ç´šï¼‰</label>
            <label><input type="checkbox" name="level" value="D"> Dï¼ˆè‹±æ¤œ1ç´šï¼‰</label>
            <label><input type="checkbox" name="level" value="E"> Eï¼ˆåˆ¥ã‚¢ãƒ—ãƒ­ãƒ¼ãƒç‰ˆï¼‰</label>
          </div>
          <p style="font-size: 0.85rem; color: var(--color-text-muted, #888); margin-top: 0.5rem;">â€» é¸æŠæ•°ãŒå¤šã„ã»ã©å‡¦ç†æ™‚é–“ãŒé•·ããªã‚Šã¾ã™</p>
          <div class="form-group">
            <label for="custom-instruction">ğŸ’¡ ã‚«ã‚¹ã‚¿ãƒ æŒ‡å®šï¼ˆä»»æ„ï¼‰</label>
            <textarea id="custom-instruction" class="essay-textarea" rows="4" placeholder="ä¾‹ï¼šæ®µè½æ§‹æˆã«ã¤ã„ã¦é‡ç‚¹çš„ã«æŒ‡å°ã—ã¦ãã ã•ã„"></textarea>

          </div>

          <div class="form-group">
            <label>ğŸ—£ï¸ æ·»å‰Šã®ãƒˆãƒ¼ãƒ³</label>
            <div style="display: flex; gap: 1.5rem; margin-top: 0.5rem;">
              <label><input type="radio" name="dialect-free" value="kansai" checked> é–¢è¥¿å¼ï¼ˆæ˜ã‚‹ãï¼‰</label>
              <label><input type="radio" name="dialect-free" value="standard"> æ¨™æº–èªï¼ˆä¸å¯§ã«ï¼‰</label>
            </div>
          </div>
        </div>

        <!-- å’Œæ–‡è‹±è¨³ã‚ªãƒ—ã‚·ãƒ§ãƒ³ -->
        <div id="options-translation" class="essay-options">
          <h3>ğŸ“š è§£ç­”ä¾‹ã®ãƒ¬ãƒ™ãƒ«ã‚’é¸æŠï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</h3>
          <div class="level-checkboxes">
            <label><input type="checkbox" name="level" value="A" checked> Aï¼ˆåŸæ–‡ãƒ™ãƒ¼ã‚¹ï¼‰</label>
            <label><input type="checkbox" name="level" value="B"> Bï¼ˆè‹±æ¤œ2ç´šï¼‰</label>
            <label><input type="checkbox" name="level" value="C"> Cï¼ˆè‹±æ¤œæº–1ç´šï¼‰</label>
            <label><input type="checkbox" name="level" value="D"> Dï¼ˆè‹±æ¤œ1ç´šï¼‰</label>
            <label><input type="checkbox" name="level" value="E"> Eï¼ˆåˆ¥ã‚¢ãƒ—ãƒ­ãƒ¼ãƒç‰ˆï¼‰</label>
          </div>
          <p style="font-size: 0.85rem; color: var(--color-text-muted, #888); margin-top: 0.5rem;">â€» é¸æŠæ•°ãŒå¤šã„ã»ã©å‡¦ç†æ™‚é–“ãŒé•·ããªã‚Šã¾ã™</p>

          <div class="form-group">
            <label>ğŸ—£ï¸ æ·»å‰Šã®ãƒˆãƒ¼ãƒ³</label>
            <div style="display: flex; gap: 1.5rem; margin-top: 0.5rem;">
              <label><input type="radio" name="dialect-trans" value="kansai" checked> é–¢è¥¿å¼ï¼ˆæ˜ã‚‹ãï¼‰</label>
              <label><input type="radio" name="dialect-trans" value="standard"> æ¨™æº–èªï¼ˆä¸å¯§ã«ï¼‰</label>
            </div>
          </div>
        </div>

        <!-- å›³è¡¨ä»˜ãè‹±ä½œæ–‡ã‚ªãƒ—ã‚·ãƒ§ãƒ³ -->
        <div id="options-diagram-essay" class="essay-options">
          <h3>ğŸ“š è§£ç­”ä¾‹ã®ãƒ¬ãƒ™ãƒ«ã‚’é¸æŠï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</h3>
          <div class="level-checkboxes">
            <label><input type="checkbox" name="level" value="A" checked> Aï¼ˆåŸæ–‡ãƒ™ãƒ¼ã‚¹ï¼‰</label>
            <label><input type="checkbox" name="level" value="B"> Bï¼ˆè‹±æ¤œ2ç´šï¼‰</label>
            <label><input type="checkbox" name="level" value="C"> Cï¼ˆè‹±æ¤œæº–1ç´šï¼‰</label>
            <label><input type="checkbox" name="level" value="D"> Dï¼ˆè‹±æ¤œ1ç´šï¼‰</label>
            <label><input type="checkbox" name="level" value="E"> Eï¼ˆåˆ¥ã‚¢ãƒ—ãƒ­ãƒ¼ãƒç‰ˆï¼‰</label>
          </div>
          <p style="font-size: 0.85rem; color: var(--color-text-muted, #888); margin-top: 0.5rem;">â€» é¸æŠæ•°ãŒå¤šã„ã»ã©å‡¦ç†æ™‚é–“ãŒé•·ããªã‚Šã¾ã™</p>

          <div class="hint">ğŸ’¡ å›³è¡¨ãŒå«ã¾ã‚Œã‚‹å ´åˆï¼ˆã¾ãŸã¯è§£ç­”ã«å›³è¡¨ã®å‚ç…§ãŒã‚ã‚‹å ´åˆï¼‰ã€ã“ã®é¸æŠè‚¢ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„</div>

          <div class="form-group">
            <label>ğŸ—£ï¸ æ·»å‰Šã®ãƒˆãƒ¼ãƒ³</label>
            <div style="display: flex; gap: 1.5rem; margin-top: 0.5rem;">
              <label><input type="radio" name="dialect-diagram" value="kansai" checked> é–¢è¥¿å¼ï¼ˆæ˜ã‚‹ãï¼‰</label>
              <label><input type="radio" name="dialect-diagram" value="standard"> æ¨™æº–èªï¼ˆä¸å¯§ã«ï¼‰</label>
            </div>
          </div>
        </div>

        <div class="step-actions">
          <button class="btn-action btn-back" onclick="goToStep(2)">â† æˆ»ã‚‹</button>
          <button class="btn-action btn-submit" onclick="submitReview()" id="submit-btn">âœï¸ æ·»å‰Šã‚’å®Ÿè¡Œ</button>
        </div>
      </div>

      <!-- ===== çµæœè¡¨ç¤º ===== -->
      <div id="result-view" class="hidden">
        <div class="result-area">
          <h3>ğŸ“ æ·»å‰Šçµæœ</h3>
          <div class="result-actions">
            <button class="btn-icon-action btn-cancel-stream hidden" id="btn-cancel-stream" onclick="cancelStreaming()">â¹ ä¸­æ–­</button>
            <button class="btn-icon-action btn-copy hidden" id="btn-copy-result" onclick="copyResult()">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
            <button class="btn-icon-action btn-print hidden" id="btn-print-result" onclick="window.print()">ğŸ–¨ï¸ å°åˆ·</button>
          </div>
          <div id="result-content" class="result-content"></div>
        </div>
        <div style="text-align: center; margin: 2rem 0;">
          <button class="btn-action btn-next" onclick="resetAndStart()">åˆ¥ã®å•é¡Œã‚’è§£ã</button>
        </div>
      </div>

      <div id="history-section" class="hidden" style="margin-top: 3rem; padding-top: 2rem; border-top: 1px solid var(--color-border, #ddd);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <h3>ğŸ“‹ éå»ã®æ·»å‰Šå±¥æ­´</h3>
          <button class="btn-action btn-clear-history" onclick="clearAllHistory()">ã™ã¹ã¦ã‚¯ãƒªã‚¢</button>
        </div>
        <div id="history-list"></div>
      </div>
    </section>
  </main>

  <footer>
    <p>ğŸ§ Yossyã®ãƒšãƒ³ã‚®ãƒ³ã•ã„ã¨ &copy; Yossy</p>
  </footer>

  <script src="theme.js"></script>
  <script>
    // ===================================================
    // Cloudflare Worker URL
    // ===================================================
    const WORKER_URL = 'https://essay-proxy.yoshida-tom-ac.workers.dev';

    // ===================================================
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    // ===================================================
    let currentAbortController = null;
    let draftSaveTimer = null;

    // ===================================================
    // çŠ¶æ…‹ç®¡ç†
    // ===================================================
    const AppState = {
      question: { text: '', source: 'text' },
      answer: { text: '', source: 'text' },
      images: { question: null, answer: null },
      essayType: 'free-essay',
      levels: ['A'],
      customInstruction: '',
      dialect: 'kansai',
      currentStep: 1
    };

    // ===================================================
    // ã‚¹ãƒ†ãƒƒãƒ—é·ç§»
    // ===================================================
    function validateStepTransition(fromStep, toStep) {
      if (fromStep === 1 && toStep === 2) {
        // ã‚¹ãƒ†ãƒƒãƒ—1â†’2: å•é¡Œæ–‡ãŒå¿…é ˆ
        const questionText = getInputValue('question');
        if (!questionText || questionText.trim() === '') {
          alert('å•é¡Œæ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
          return false;
        }
      }
      if (fromStep === 2 && toStep === 3) {
        // ã‚¹ãƒ†ãƒƒãƒ—2â†’3: è‹±ä½œæ–‡ãŒå¿…é ˆ
        const answerText = getInputValue('answer');
        if (!answerText || answerText.trim() === '') {
          alert('è‹±ä½œæ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
          return false;
        }
      }
      return true;
    }

    function goToStep(stepNum) {
      if (stepNum < 1 || stepNum > 3) return;

      // ã‚¹ãƒ†ãƒƒãƒ—é·ç§»ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      if (stepNum > AppState.currentStep && !validateStepTransition(AppState.currentStep, stepNum)) {
        return;
      }

      // ç¾åœ¨ã®ã‚¹ãƒ†ãƒƒãƒ—ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
      if (AppState.currentStep === 1) {
        AppState.question.text = getInputValue('question');
      }
      if (AppState.currentStep === 2) {
        AppState.answer.text = getInputValue('answer');
      }

      // ã‚¹ãƒ†ãƒƒãƒ—ã‚’åˆ‡ã‚Šæ›¿ãˆ
      document.querySelectorAll('.step-container').forEach(el => {
        el.classList.remove('active');
      });
      document.getElementById(`step-${stepNum}`).classList.add('active');

      AppState.currentStep = stepNum;
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // å…¥åŠ›å€¤å–å¾—ï¼ˆæ‰‹å…¥åŠ›ã¾ãŸã¯OCRä¿®æ­£å¾Œï¼‰
    function getInputValue(field) {
      const ocrDisplay = document.getElementById(`${field}-ocr-display`);
      const ocrText = document.getElementById(`${field}-ocr-text`);
      const textInput = document.getElementById(`${field}-text-input`);

      // OCRçµæœãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚Œã°ã€OCRãƒ†ã‚­ã‚¹ãƒˆã‚’å„ªå…ˆ
      if (ocrDisplay && !ocrDisplay.classList.contains('hidden') && ocrText) {
        return ocrText.value;
      }
      // ãã†ã§ãªã‘ã‚Œã°æ‰‹å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆã‚’è¿”ã™
      return textInput?.value || '';
    }

    // ===================================================
    // å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
    // ===================================================
    function switchInputMode(event) {
      const mode = event.target.dataset.mode;
      const field = event.target.dataset.field;

      // ã‚¿ãƒ–ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆ
      document.querySelectorAll(`[data-field="${field}"]`).forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');

      // å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ã®è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
      const textMode = document.getElementById(`${field}-text-mode`);
      const imageMode = document.getElementById(`${field}-image-mode`);

      if (mode === 'text') {
        textMode.classList.add('active');
        imageMode.classList.remove('active');
      } else {
        textMode.classList.remove('active');
        imageMode.classList.add('active');
        // ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚’é¸æŠæ™‚ã€ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒªã‚¢ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
        setTimeout(() => {
          const uploadArea = document.getElementById(`${field}-upload-area`);
          if (uploadArea) {
            uploadArea.scrollIntoView({ behavior: 'smooth', block: 'center' });
          }
        }, 100);
      }

      AppState[field].source = mode;
    }

    // ===================================================
    // ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ & OCR
    // ===================================================
    function triggerFileInput(field) {
      // ç”»åƒãŒã™ã§ã«ã‚ã‚‹å ´åˆã¯ã‚¯ãƒªãƒƒã‚¯ã§å†é¸æŠã—ãªã„ï¼ˆå‰Šé™¤ãƒœã‚¿ãƒ³ç­‰ã®ã‚¯ãƒªãƒƒã‚¯ã‚’å¦¨ã’ãªã„ãŸã‚ï¼‰
      if (AppState.images[field]) return;
      document.getElementById(`${field}-image-input`).click();
    }

    function handleDragOver(e) {
      e.preventDefault();
      e.stopPropagation();
      const area = e.currentTarget;
      area.classList.add('drag-over');
    }

    function handleDragLeave(e) {
      e.preventDefault();
      e.stopPropagation();
      const area = e.currentTarget;
      area.classList.remove('drag-over');
    }

    function handleDrop(e) {
      e.preventDefault();
      e.stopPropagation();
      const area = e.currentTarget;
      area.classList.remove('drag-over');

      const files = e.dataTransfer.files;
      if (files.length > 0) {
        const event = new Event('change');
        Object.defineProperty(event, 'target', { value: { files }, enumerable: true });
        handleImageUpload(event, area.id.split('-')[0]);
      }
    }

    // ç”»åƒã‚’æœ€å¤§1568pxã«ãƒªã‚µã‚¤ã‚ºã—ã¦base64ã§è¿”ã™ï¼ˆAPI ã®ãƒ“ã‚¸ãƒ§ãƒ³ãƒˆãƒ¼ã‚¯ãƒ³å‰Šæ¸›ç”¨ï¼‰
    function resizeImage(base64, maxSize = 1568) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
          // ãƒªã‚µã‚¤ã‚ºä¸è¦ãªã‚‰ãã®ã¾ã¾è¿”ã™
          if (img.width <= maxSize && img.height <= maxSize) {
            resolve(base64);
            return;
          }
          const scale = Math.min(maxSize / img.width, maxSize / img.height);
          const w = Math.round(img.width * scale);
          const h = Math.round(img.height * scale);
          const canvas = document.createElement('canvas');
          canvas.width = w;
          canvas.height = h;
          const ctx = canvas.getContext('2d');
          ctx.drawImage(img, 0, 0, w, h);
          // å…ƒã®å½¢å¼ã‚’ç¶­æŒï¼ˆJPEG/WebP ã¯å“è³ª85%ã§å†ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ï¼‰
          const mime = base64.split(';')[0].split(':')[1] || 'image/jpeg';
          const quality = (mime === 'image/png' || mime === 'image/gif') ? undefined : 0.85;
          resolve(canvas.toDataURL(mime, quality));
        };
        img.src = base64;
      });
    }

    async function handleImageUpload(event, field) {
      const file = event.target.files[0];
      if (!file) return;

      // ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ãƒ»ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯
      const SUPPORTED_TYPES = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
      if (!SUPPORTED_TYPES.includes(file.type)) {
        alert('å¯¾å¿œã—ã¦ã„ãªã„ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã§ã™ã€‚\nJPEG, PNG, GIF, WebP ã®ç”»åƒã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
        return;
      }
      if (file.size > 10 * 1024 * 1024) {
        alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã¯10MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„ã€‚');
        return;
      }

      const reader = new FileReader();
      reader.onload = async (e) => {
        // APIã®ãƒ“ã‚¸ãƒ§ãƒ³ãƒˆãƒ¼ã‚¯ãƒ³å‰Šæ¸›ã®ãŸã‚æœ€å¤§1568pxã«ãƒªã‚µã‚¤ã‚º
        const base64 = await resizeImage(e.target.result);
        AppState.images[field] = base64;

        // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼è¡¨ç¤º
        displayImagePreview(field, file.name);

        // OCRå®Ÿè¡Œ
        await performOCR(base64, field);
      };
      reader.readAsDataURL(file);
    }

    function displayImagePreview(field, fileName) {
      const preview = document.getElementById(`${field}-image-preview`);
      const base64 = AppState.images[field];

      preview.innerHTML = `
        <div class="image-preview-item">
          <img src="${base64}" alt="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼">
          <p class="image-preview-name">${fileName}</p>
          <button class="btn-remove-image" onclick="removeImage('${field}')">å‰Šé™¤</button>
        </div>
      `;
      preview.classList.remove('hidden');

      document.querySelector(`#${field}-upload-area .upload-placeholder`).classList.add('hidden');
    }

    function removeImage(field) {
      AppState.images[field] = null;
      document.getElementById(`${field}-image-input`).value = '';
      document.getElementById(`${field}-image-preview`).innerHTML = '';
      document.getElementById(`${field}-image-preview`).classList.add('hidden');
      document.querySelector(`#${field}-upload-area .upload-placeholder`).classList.remove('hidden');
      document.getElementById(`${field}-ocr-display`).classList.add('hidden');
      document.getElementById(`${field}-ocr-loading`).classList.remove('active');
    }

    function cleanOCRText(text) {
      // ä¸è¦ãªãƒ†ã‚­ã‚¹ãƒˆã‚’å‰Šé™¤
      const patterns = [
        /ã“ã‚Œã¯æ‰‹æ›¸ãã§ã™\.?/gi,
        /æ°å\s*[:ï¼š]?\s*.*?(?=\n|$)/gi,
        /åå‰\s*[:ï¼š]?\s*.*?(?=\n|$)/gi,
        /ã‚¯ãƒ©ã‚¹\s*[:ï¼š]?\s*.*?(?=\n|$)/gi,
        /å­¦å¹´\s*[:ï¼š]?\s*.*?(?=\n|$)/gi,
        /æ—¥ä»˜\s*[:ï¼š]?\s*.*?(?=\n|$)/gi,
        /å¹´\s*æœˆ\s*æ—¥/gi,
        // AIãŒå‹æ‰‹ã«è¿½åŠ ã™ã‚‹ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¦‹å‡ºã—ã‚’é™¤å»
        /^#{1,3}\s*(ç”»åƒã®åˆ†é¡|ã‚¿ã‚¤ãƒˆãƒ«|å†…å®¹|å˜ä½ãƒ»å‡¡ä¾‹ãƒ»è»¸ãƒ©ãƒ™ãƒ«|å‡ºå…¸|èª­ã¿å–ã‚Šä¸ç¢ºå®Ÿãªéƒ¨åˆ†|OCRèª­ã¿å–ã‚Šçµæœ)\s*$/gm,
        // è¦‹å‡ºã—ç›´å¾Œã®ã€Œãªã—ã€ã ã‘ã®è¡Œã‚’é™¤å»
        /^ãªã—\s*$/gm,
        /^\s*$/gm  // ç©ºè¡Œã‚’æ•´ç†
      ];

      let cleaned = text;
      for (const pattern of patterns) {
        cleaned = cleaned.replace(pattern, '');
      }

      // è¤‡æ•°ã®æ”¹è¡Œã‚’1è¡Œã«
      cleaned = cleaned.replace(/\n\n+/g, '\n');
      // å…ˆé ­ãƒ»æœ«å°¾ã®ç©ºç™½ã‚’å‰Šé™¤
      cleaned = cleaned.trim();

      return cleaned;
    }

    async function performOCR(base64, field) {
      const display = document.getElementById(`${field}-ocr-display`);
      const textArea = document.getElementById(`${field}-ocr-text`);
      const loading = document.getElementById(`${field}-ocr-loading`);

      if (!display || !textArea) {
        console.error(`OCRè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${field}`);
        alert('ã‚¨ãƒ©ãƒ¼ï¼šOCRè¡¨ç¤ºè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }

      // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
      if (loading) loading.classList.add('active');
      display.classList.add('hidden');

      try {
        console.log(`[OCR] ${field} å‡¦ç†é–‹å§‹...`);
        const response = await fetch(WORKER_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            essayType: 'diagram-ocr',
            imageBase64: base64
          })
        });

        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`OCRå‡¦ç†ã‚¨ãƒ©ãƒ¼: ${response.status} ${errorText}`);
        }

        // ã‚¹ãƒˆãƒªãƒ¼ãƒ å‡¦ç†ã§OCRçµæœã‚’å–å¾—
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';
        let fullText = '';

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          buffer += decoder.decode(value, { stream: true });
          const lines = buffer.split('\n');
          buffer = lines.pop();

          for (const line of lines) {
            if (line.startsWith('data: ')) {
              try {
                const json = JSON.parse(line.slice(6));
                if (json.type === 'content_block_delta' && json.delta?.type === 'text_delta') {
                  fullText += json.delta.text || '';
                }
              } catch (e) {
                // JSON parse error ã‚’ç„¡è¦–
              }
            }
          }
        }

        if (!fullText || fullText.trim() === '') {
          console.warn('[OCR] ãƒ†ã‚­ã‚¹ãƒˆãŒå–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ');
          textArea.value = 'ã€OCRã§èª­ã¿å–ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚æ‰‹å‹•ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‘';
        } else {
          // OCRçµæœã‚’ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°
          const cleanedText = cleanOCRText(fullText);
          console.log('[OCR] ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°å‰:', fullText.substring(0, 100));
          console.log('[OCR] ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°å¾Œ:', cleanedText.substring(0, 100));
          textArea.value = cleanedText;
        }

        if (loading) loading.classList.remove('active');
        display.classList.remove('hidden');
        console.log(`[OCR] ${field} å®Œäº†`);

        // ã‚¹ãƒãƒ›ã§ãƒ•ã‚©ãƒ¼ãƒ ãŒã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¤–ã«ãªã‚‰ãªã„ã‚ˆã†èª¿æ•´
        setTimeout(() => {
          display.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 100);

      } catch (error) {
        console.error('[OCR ã‚¨ãƒ©ãƒ¼]', error);
        if (loading) loading.classList.remove('active');
        textArea.value = `ã‚¨ãƒ©ãƒ¼: ${error.message}\n\næ‰‹å‹•ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚`;
        display.classList.remove('hidden');
      }
    }

    // ===================================================
    // å•é¡Œã‚¿ã‚¤ãƒ—é¸æŠ
    // ===================================================
    function selectEssayType(event) {
      const type = event.target.dataset.type;
      AppState.essayType = type;

      // ã‚¿ãƒ–ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆ
      document.querySelectorAll('.type-tab').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');

      // ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
      document.querySelectorAll('.essay-options').forEach(opt => {
        opt.classList.remove('active');
      });
      document.getElementById(`options-${type}`).classList.add('active');
    }

    // ===================================================
    // æ·»å‰Šå®Ÿè¡Œ
    // ===================================================
    async function submitReview() {
      // æœ€æ–°ã®å…¥åŠ›å€¤ã‚’å–å¾—
      AppState.question.text = getInputValue('question');
      AppState.answer.text = getInputValue('answer');

      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      if (!AppState.question.text.trim()) {
        alert('å•é¡Œæ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      if (!AppState.answer.text.trim()) {
        alert('è§£ç­”ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      // ãƒ¬ãƒ™ãƒ«é¸æŠã‚’å–å¾—
      const selectedLevels = Array.from(
        document.querySelectorAll('.essay-options.active input[name="level"]:checked')
      ).map(el => el.value);
      AppState.levels = selectedLevels.length > 0 ? selectedLevels : ['A'];

      // ã‚«ã‚¹ã‚¿ãƒ æŒ‡å®šï¼ˆè‡ªç”±è‹±ä½œæ–‡ï¼‰
      const customInput = document.getElementById('custom-instruction');
      AppState.customInstruction = customInput?.value.trim() || '';

      // æ–¹è¨€
      const dialectRadio = document.querySelector(`.essay-options.active input[name="dialect-${AppState.essayType}"]:checked`);
      AppState.dialect = dialectRadio?.value || 'kansai';

      // Workerã¸ã®ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰
      let payload = {
        essayType: AppState.essayType,
        types: AppState.levels,
        dialect: AppState.dialect
      };

      if (AppState.essayType === 'free-essay') {
        payload.question = AppState.question.text;
        payload.answer = AppState.answer.text;
        payload.customInstruction = AppState.customInstruction;
      } else if (AppState.essayType === 'translation') {
        payload.japaneseText = AppState.question.text;
        payload.answer = AppState.answer.text;
      } else if (AppState.essayType === 'diagram-essay') {
        payload.question = AppState.question.text;
        payload.answer = AppState.answer.text;
        // è§£ç­”ãŒç”»åƒã®å ´åˆã€å›³è¡¨ã¨ã—ã¦æ‰±ã†
        if (AppState.images.answer) {
          payload.imageBase64 = AppState.images.answer;
        }
      }

      // UIæ›´æ–°
      const btn = document.getElementById('submit-btn');
      btn.disabled = true;
      btn.textContent = 'ğŸ”„ æ·»å‰Šä¸­â€¦';

      document.querySelectorAll('.step-container').forEach(el => {
        el.classList.remove('active');
      });
      document.getElementById('result-view').classList.remove('hidden');
      const resultContent = document.getElementById('result-content');
      resultContent.innerHTML = '<p>å‡¦ç†ä¸­â€¦</p>';
      window.scrollTo({ top: 0, behavior: 'smooth' });

      // ä¸­æ–­ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
      currentAbortController = new AbortController();
      showCancelButton();

      try {
        const response = await fetch(WORKER_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
          signal: currentAbortController.signal
        });

        if (!response.ok) {
          const msg = await response.text();
          throw new Error(`ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ (${response.status}): ${msg}`);
        }

        // ã‚¹ãƒˆãƒªãƒ¼ãƒ å‡¦ç†ã§çµæœã‚’å—ã‘å–ã‚Š
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';
        let fullText = '';

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;

          buffer += decoder.decode(value, { stream: true });
          const lines = buffer.split('\n');
          buffer = lines.pop();

          for (const line of lines) {
            if (line.startsWith('data: ')) {
              try {
                const json = JSON.parse(line.slice(6));
                if (json.type === 'content_block_delta' && json.delta?.type === 'text_delta') {
                  fullText += json.delta.text || '';
                  resultContent.innerHTML = renderMarkdown(fullText);
                }
              } catch (e) {
                // ignore
              }
            }
          }
        }

        if (!fullText) {
          resultContent.innerHTML = '<p>ã‚¨ãƒ©ãƒ¼ï¼šæ·»å‰Šçµæœã‚’å—ã‘å–ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚</p>';
        } else {
          // å±¥æ­´ã«ä¿å­˜ãƒ»ä¸‹æ›¸ãã‚¯ãƒªã‚¢
          saveToHistory(AppState.question.text, AppState.answer.text, resultContent.innerHTML, AppState.essayType);
          localStorage.removeItem('essayDraft');
        }

      } catch (error) {
        if (error.name === 'AbortError') {
          if (resultContent.innerHTML === '<p>å‡¦ç†ä¸­â€¦</p>') {
            resultContent.innerHTML = '<p style="color:var(--color-text-muted,#888);">ï¼ˆæ·»å‰Šã‚’ä¸­æ–­ã—ã¾ã—ãŸï¼‰</p>';
          } else {
            resultContent.innerHTML += '<p style="color:var(--color-text-muted,#888); margin-top:1rem;">ï¼ˆæ·»å‰Šã‚’ä¸­æ–­ã—ã¾ã—ãŸï¼‰</p>';
          }
        } else {
          resultContent.innerHTML = `<p>ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}</p>`;
          console.error('[Essay]', error);
        }
      } finally {
        currentAbortController = null;
        showResultActions();
        btn.disabled = false;
        btn.textContent = 'âœï¸ æ·»å‰Šã‚’å®Ÿè¡Œ';
      }
    }

    // ===================================================
    // ãƒªã‚»ãƒƒãƒˆ
    // ===================================================
    function resetAndStart() {
      AppState.question = { text: '', source: 'text' };
      AppState.answer = { text: '', source: 'text' };
      AppState.images = { question: null, answer: null };
      AppState.essayType = 'free-essay';
      AppState.levels = ['A'];
      AppState.customInstruction = '';
      AppState.dialect = 'kansai';

      // ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢
      document.getElementById('question-text-input').value = '';
      document.getElementById('answer-text-input').value = '';
      document.getElementById('custom-instruction').value = '';
      updateWordCount();
      localStorage.removeItem('essayDraft');
      const draftIndicator = document.getElementById('draft-indicator');
      if (draftIndicator) draftIndicator.textContent = '';

      // ç”»åƒã‚’ã‚¯ãƒªã‚¢
      ['question', 'answer'].forEach(field => {
        document.getElementById(`${field}-image-input`).value = '';
        document.getElementById(`${field}-image-preview`).innerHTML = '';
        document.getElementById(`${field}-image-preview`).classList.add('hidden');
        document.querySelector(`#${field}-upload-area .upload-placeholder`).classList.remove('hidden');
        document.getElementById(`${field}-ocr-display`).classList.add('hidden');
        document.getElementById(`${field}-ocr-loading`).classList.remove('active');
      });

      // ã‚¹ãƒ†ãƒƒãƒ—1ã¸
      document.getElementById('result-view').classList.add('hidden');
      goToStep(1);
    }

    // ===================================================
    // èªæ•°ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼
    // ===================================================
    function updateWordCount() {
      const textarea = document.getElementById('answer-text-input');
      const display = document.getElementById('word-count-display');
      if (!textarea || !display) return;
      const val = textarea.value.trim();
      const count = val ? val.split(/\s+/).length : 0;
      display.textContent = `èªæ•°: ${count}èª`;
    }

    // ===================================================
    // ä¸‹æ›¸ãè‡ªå‹•ä¿å­˜
    // ===================================================
    function scheduleDraftSave() {
      clearTimeout(draftSaveTimer);
      draftSaveTimer = setTimeout(() => {
        const val = document.getElementById('answer-text-input').value;
        if (val.trim()) {
          localStorage.setItem('essayDraft', val);
          const indicator = document.getElementById('draft-indicator');
          if (indicator) {
            indicator.textContent = 'âœ“ è‡ªå‹•ä¿å­˜æ¸ˆã¿';
            setTimeout(() => {
              if (indicator.textContent === 'âœ“ è‡ªå‹•ä¿å­˜æ¸ˆã¿') indicator.textContent = '';
            }, 2000);
          }
        } else {
          localStorage.removeItem('essayDraft');
        }
      }, 1000);
    }

    function restoreDraft() {
      const saved = localStorage.getItem('essayDraft');
      if (!saved) return;
      const textarea = document.getElementById('answer-text-input');
      if (!textarea) return;
      textarea.value = saved;
      updateWordCount();
      const indicator = document.getElementById('draft-indicator');
      if (indicator) indicator.textContent = 'ï¼ˆå‰å›ã®ä¸‹æ›¸ãã‚’å¾©å…ƒã—ã¾ã—ãŸï¼‰';
    }

    // ===================================================
    // æ·»å‰Šçµæœã‚³ãƒ”ãƒ¼
    // ===================================================
    function copyResult() {
      const resultContent = document.getElementById('result-content');
      const text = resultContent.innerText || resultContent.textContent;
      const btn = document.getElementById('btn-copy-result');

      const showSuccess = () => {
        btn.textContent = 'âœ… ã‚³ãƒ”ãƒ¼æ¸ˆã¿';
        setTimeout(() => { btn.textContent = 'ğŸ“‹ ã‚³ãƒ”ãƒ¼'; }, 2000);
      };

      if (navigator.clipboard) {
        navigator.clipboard.writeText(text).then(showSuccess).catch(() => alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚'));
      } else {
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆå¤ã„ãƒ–ãƒ©ã‚¦ã‚¶å‘ã‘ï¼‰
        const range = document.createRange();
        range.selectNode(resultContent);
        window.getSelection().removeAllRanges();
        window.getSelection().addRange(range);
        try {
          document.execCommand('copy');
          window.getSelection().removeAllRanges();
          showSuccess();
        } catch (e) {
          alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
        }
      }
    }

    // ===================================================
    // ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ä¸­æ–­
    // ===================================================
    function cancelStreaming() {
      if (currentAbortController) {
        currentAbortController.abort();
      }
    }

    function showCancelButton() {
      document.getElementById('btn-cancel-stream').classList.remove('hidden');
      document.getElementById('btn-copy-result').classList.add('hidden');
      document.getElementById('btn-print-result').classList.add('hidden');
    }

    function showResultActions() {
      document.getElementById('btn-cancel-stream').classList.add('hidden');
      document.getElementById('btn-copy-result').classList.remove('hidden');
      document.getElementById('btn-print-result').classList.remove('hidden');
    }

    // ===================================================
    // Markdown ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    // ===================================================
    function escapeHtml(s) {
      return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    function formatInline(s) {
      return s
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/`(.+?)`/g, '<code>$1</code>');
    }

    function renderMarkdown(text) {
      if (typeof text !== 'string') return '<p>ï¼ˆå†…å®¹ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸï¼‰</p>';
      const lines = text.split('\n');
      let html = '';
      let inList = false;

      for (const line of lines) {
        if (line.startsWith('## ')) {
          if (inList) { html += '</ul>'; inList = false; }
          html += `<h3 class="r-h3">${formatInline(escapeHtml(line.slice(3)))}</h3>`;
        } else if (line.startsWith('### ')) {
          if (inList) { html += '</ul>'; inList = false; }
          html += `<h4 class="r-h4">${formatInline(escapeHtml(line.slice(4)))}</h4>`;
        } else if (/^[-*] /.test(line)) {
          if (!inList) { html += '<ul class="r-list">'; inList = true; }
          html += `<li>${formatInline(escapeHtml(line.slice(2)))}</li>`;
        } else if (line.trim() === '') {
          if (inList) { html += '</ul>'; inList = false; }
        } else {
          if (inList) { html += '</ul>'; inList = false; }
          html += `<p class="r-p">${formatInline(escapeHtml(line))}</p>`;
        }
      }

      if (inList) html += '</ul>';
      return html;
    }

    // ===================================================
    // å±¥æ­´ç®¡ç†
    // ===================================================
    function saveToHistory(question, answer, result, essayType) {
      try {
        const history = JSON.parse(localStorage.getItem('essayHistory') || '[]');
        const item = {
          id: Date.now(),
          timestamp: new Date().toISOString(),
          question: question.substring(0, 100),
          answer: answer.substring(0, 100),
          result: result,
          essayType: essayType
        };
        history.unshift(item);
        // æœ€æ–°100ä»¶ã¾ã§ä¿æŒ
        if (history.length > 100) history.pop();
        localStorage.setItem('essayHistory', JSON.stringify(history));
        displayHistory();
      } catch (e) {
        console.error('å±¥æ­´ä¿å­˜ã‚¨ãƒ©ãƒ¼:', e);
      }
    }

    function loadHistoryFromStorage() {
      try {
        return JSON.parse(localStorage.getItem('essayHistory') || '[]');
      } catch (e) {
        console.error('å±¥æ­´èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
        return [];
      }
    }

    function displayHistory() {
      const history = loadHistoryFromStorage();
      const historySection = document.getElementById('history-section');
      const historyList = document.getElementById('history-list');

      if (history.length === 0) {
        historySection.classList.add('hidden');
        return;
      }

      historySection.classList.remove('hidden');
      historyList.innerHTML = '';

      history.forEach(item => {
        const date = new Date(item.timestamp);
        const dateStr = date.toLocaleString('ja-JP');
        const typeLabel = {
          'free-essay': 'è‡ªç”±è‹±ä½œæ–‡',
          'translation': 'å’Œæ–‡è‹±è¨³',
          'diagram-essay': 'å›³è¡¨ä»˜ãè‹±ä½œæ–‡'
        }[item.essayType] || item.essayType;

        const historyEl = document.createElement('div');
        historyEl.className = 'history-item';
        historyEl.innerHTML = `
          <div class="history-item-row">
            <div class="history-item-meta">
              <span class="history-date">${dateStr}</span>
              <span class="history-type-badge">${typeLabel}</span>
              <span class="history-preview">${item.answer}</span>
            </div>
            <div class="history-item-actions">
              <button class="btn-hist-view" onclick="viewHistoryItem(${item.id})">è¡¨ç¤º</button>
              <button class="btn-hist-del" onclick="deleteHistoryItem(${item.id})">å‰Šé™¤</button>
            </div>
          </div>
        `;
        historyList.appendChild(historyEl);
      });
    }

    function viewHistoryItem(id) {
      const history = loadHistoryFromStorage();
      const item = history.find(h => h.id === id);
      if (item) {
        const resultContent = document.getElementById('result-content');
        document.querySelectorAll('.step-container').forEach(el => {
          el.classList.remove('active');
        });
        document.getElementById('result-view').classList.remove('hidden');
        resultContent.innerHTML = item.result;
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }
    }

    function deleteHistoryItem(id) {
      if (!confirm('ã“ã®é …ç›®ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
      try {
        let history = JSON.parse(localStorage.getItem('essayHistory') || '[]');
        history = history.filter(h => h.id !== id);
        localStorage.setItem('essayHistory', JSON.stringify(history));
        displayHistory();
      } catch (e) {
        console.error('å‰Šé™¤ã‚¨ãƒ©ãƒ¼:', e);
      }
    }

    function clearAllHistory() {
      if (!confirm('ã™ã¹ã¦ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
      try {
        localStorage.removeItem('essayHistory');
        displayHistory();
      } catch (e) {
        console.error('ã‚¯ãƒªã‚¢ã‚¨ãƒ©ãƒ¼:', e);
      }
    }

    // ===================================================
    // åˆæœŸåŒ–
    // ===================================================
    document.addEventListener('DOMContentLoaded', () => {
      // ã‚¿ã‚¤ãƒ—ã‚¿ãƒ–ã®åˆæœŸåŒ–
      document.querySelectorAll('.type-tab').forEach(btn => {
        btn.addEventListener('click', selectEssayType);
      });

      // ãƒ¢ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã®åˆæœŸåŒ–
      document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.addEventListener('click', switchInputMode);
      });

      // è§£ç­”ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ï¼šèªæ•°ã‚«ã‚¦ãƒ³ãƒˆï¼‹ä¸‹æ›¸ãè‡ªå‹•ä¿å­˜
      const answerTextarea = document.getElementById('answer-text-input');
      if (answerTextarea) {
        answerTextarea.addEventListener('input', () => {
          updateWordCount();
          scheduleDraftSave();
        });
      }

      // ä¸‹æ›¸ãã‚’å¾©å…ƒ
      restoreDraft();

      // å±¥æ­´ã‚’è¡¨ç¤º
      displayHistory();
    });
  </script>

</body>
</html>
