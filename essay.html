<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è‹±ä½œæ–‡æ·»å‰Š - Yossyã®ãƒšãƒ³ã‚®ãƒ³ã•ã„ã¨</title>
  <meta name="description" content="AIæ·»å‰Šæ©Ÿèƒ½ã‚’ä½¿ã£ã¦è‹±ä½œæ–‡ã‚’æ”¹å–„ã€‚ã‚ãªãŸã®è‹±ä½œæ–‡ã‚’ãƒ†ãƒ¼ãƒã‚„æŒ‡ç¤ºæ–‡ã«æ²¿ã‚ã›ã¦æ·»å‰Šã—ã¾ã™ã€‚">
  <meta name="author" content="Yossy">
  <meta name="theme-color" content="#1a2e44">

  <!-- OGP -->
  <meta property="og:title" content="è‹±ä½œæ–‡æ·»å‰Š - Yossyã®ãƒšãƒ³ã‚®ãƒ³ã•ã„ã¨">
  <meta property="og:description" content="AIæ·»å‰Šæ©Ÿèƒ½ã‚’ä½¿ã£ã¦è‹±ä½œæ–‡ã‚’æ”¹å–„ã€‚è©³ã—ã„è§£èª¬ä»˜ãã§å­¦ç¿’ã§ãã¾ã™ã€‚">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://yossy-ac.github.io/YossyHP/essay.html">
  <meta property="og:image" content="https://yossy-ac.github.io/YossyHP/og-image.svg">

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="è‹±ä½œæ–‡æ·»å‰Š - Yossyã®ãƒšãƒ³ã‚®ãƒ³ã•ã„ã¨">
  <meta name="twitter:description" content="AIæ·»å‰Šã§è‹±ä½œæ–‡ã‚’æ”¹å–„ã€‚è©³ã—ã„è§£èª¬ä»˜ãã€‚">
  <meta name="twitter:image" content="https://yossy-ac.github.io/YossyHP/og-image.svg">

  <link rel="stylesheet" href="style.css">
  <script>if(localStorage.getItem('theme')==='dark')document.documentElement.setAttribute('data-theme','dark');</script>
</head>
<body>

  <header>
    <div class="header-inner">
      <span class="logo">ğŸ§</span>
      <div>
        <h1><a href="index.html" class="site-title-link">Yossyã®ãƒšãƒ³ã‚®ãƒ³ã•ã„ã¨</a></h1>
        <p class="tagline"><a href="https://www.youtube.com/@yossy0116" target="_blank" rel="noopener noreferrer">ğŸ¥ Yossyã®ãƒšãƒ³ã‚®ãƒ³ã¡ã‚ƒã‚“ã­ã‚‹</a></p>
      </div>
    </div>
    <button class="theme-toggle" id="theme-toggle" title="ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ" aria-label="ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ">ğŸŒ™</button>
  </header>

  <nav class="site-nav">
    <ul>
      <li><a href="index.html">ğŸ  ãƒ›ãƒ¼ãƒ </a></li>
      <li><a href="about.html">ğŸ§ è‡ªå·±ç´¹ä»‹</a></li>
      <li><a href="essay.html" class="active">âœï¸ è‹±ä½œæ–‡æ·»å‰Š</a></li>
      <li><a href="contact.html">ğŸ“ ãŠä¾¿ã‚Š</a></li>
      <li><a href="files-download.html">ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</a></li>
    </ul>
  </nav>

  <main>
    <section class="essay-section">
      <h2>è‹±ä½œæ–‡ AIæ·»å‰Š</h2>
      <p class="section-desc">æ·»å‰Šã®ã€Œèªæ•°ã€ã¯ä¿¡ã˜ãŸã‚‰ã‚ã‹ã‚“ï¾ƒï¾ ã€Œï½ã¯å¿…é ˆï¼ã€ã‚‚ä¿¡ã˜ã¦ã„ã„ã‹ã‚ã‹ã‚‰ã‚“ï¾ƒï¾ã€€å›³è¡¨ã¯ï¾‘ï¾˜ã‚„ï¾ƒï¾</p>

      <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
      <div class="tab-nav">
        <button class="tab-btn tab-btn--active" data-tab="free-essay">ãµã¤ã†ã®è‹±ä½œæ–‡</button>
        <button class="tab-btn" data-tab="translation">å’Œæ–‡è‹±è¨³</button>
        <button class="tab-btn" data-tab="diagram-essay">å›³è¡¨ä»˜ãè‹±ä½œæ–‡</button>
      </div>

      <!-- ã‚¿ãƒ–1: ãµã¤ã†ã®è‹±ä½œæ–‡ -->
      <div class="essay-card tab-content tab-content--active" id="free-essay">
        <h3 class="essay-subheading">ãµã¤ã†ã®è‹±ä½œæ–‡ AIæ·»å‰Š</h3>
        <div class="form-group">
          <label for="question-free">å•é¡Œæ–‡ï¼ˆãƒ†ãƒ¼ãƒãƒ»æŒ‡ç¤ºæ–‡ï¼‰</label>
          <textarea id="question-free" class="essay-textarea" rows="4"
            placeholder="ä¾‹: Describe the advantages of studying abroad in about 100 words."></textarea>
        </div>

        <div class="form-group">
          <label for="answer-free">ã‚ãªãŸã®ä½œå“</label>
          <textarea id="answer-free" class="essay-textarea essay-textarea--answer" rows="10"
            placeholder="è‹±ä½œæ–‡ã‚’ã“ã“ã«å…¥åŠ›ã—ã¦ãã ã•ã„â€¦"></textarea>
        </div>

        <div class="form-group">
          <label>è§£ç­”ä¾‹ã‚¿ã‚¤ãƒ—ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
          <div class="checkbox-group">
            <label class="checkbox-label">
              <input type="checkbox" id="type-A" name="types" value="A" checked>
              Aï¼ˆåŸæ–‡ãƒ™ãƒ¼ã‚¹ï¼‰
            </label>
            <label class="checkbox-label">
              <input type="checkbox" id="type-B" name="types" value="B">
              Bï¼ˆè‹±æ¤œ2ç´šï¼‰
            </label>
            <label class="checkbox-label">
              <input type="checkbox" id="type-C" name="types" value="C">
              Cï¼ˆè‹±æ¤œæº–1ç´šï¼‰
            </label>
            <label class="checkbox-label">
              <input type="checkbox" id="type-D" name="types" value="D">
              Dï¼ˆè‹±æ¤œ1ç´šï¼‰
            </label>
            <label class="checkbox-label">
              <input type="checkbox" id="type-E" name="types" value="E">
              Eï¼ˆåˆ¥ã‚¢ãƒ—ãƒ­ãƒ¼ãƒç‰ˆï¼‰
            </label>
          </div>
        </div>

        <div class="form-group">
          <button class="btn-collapsible" onclick="toggleCustomSection()">
            <span id="custom-toggle-text">â–¶ Fï¼šè§£ç­”ä¾‹ã‚’è©³ã—ãæŒ‡å®šã™ã‚‹</span>
          </button>
          <div id="custom-section" class="custom-section" hidden>
            <label for="custom-instruction">ã‚«ã‚¹ã‚¿ãƒ æŒ‡å®šï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰</label>
            <textarea id="custom-instruction" class="essay-textarea essay-textarea--custom" rows="4"
              placeholder="ä¾‹ï¼šCEFR B1ãƒ¬ãƒ™ãƒ«ã§ã€æ—¥å¸¸çš„ãªèªå½™ã‚’ç”¨ã„ãŸè§£ç­”ä¾‹ãŒã»ã—ã„ã€‚ã¾ãŸã¯ã€ã‚ˆã‚Šå½¢å¼çš„ãªè¡¨ç¾ã‚’ä½¿ã£ãŸåˆ¥ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒã»ã—ã„ã€‚"></textarea>
          </div>
        </div>

        <button class="btn-submit" onclick="submitEssay('free-essay')">âœï¸ æ·»å‰Šã™ã‚‹</button>
      </div>

      <!-- ã‚¿ãƒ–2: å’Œæ–‡è‹±è¨³ -->
      <div class="essay-card tab-content" id="translation">
        <h3 class="essay-subheading">å’Œæ–‡è‹±è¨³ AIæ·»å‰Š</h3>
        <div class="form-group">
          <label for="japanese-text">æ—¥æœ¬èªãƒ†ã‚­ã‚¹ãƒˆ</label>
          <textarea id="japanese-text" class="essay-textarea" rows="6"
            placeholder="æ—¥æœ¬èªã‚’å…¥åŠ›ã—ã¦ãã ã•ã„â€¦"></textarea>
        </div>

        <div class="form-group">
          <label for="answer-translation">ã‚ãªãŸã®è‹±è¨³</label>
          <textarea id="answer-translation" class="essay-textarea essay-textarea--answer" rows="10"
            placeholder="è‹±è¨³ã‚’ã“ã“ã«å…¥åŠ›ã—ã¦ãã ã•ã„â€¦"></textarea>
        </div>

        <div class="form-group">
          <label>è§£ç­”ä¾‹ã‚¿ã‚¤ãƒ—ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
          <div class="checkbox-group">
            <label class="checkbox-label">
              <input type="checkbox" id="trans-type-A" name="trans-types" value="A" checked>
              Aï¼ˆåŸæ–‡ãƒ™ãƒ¼ã‚¹ï¼‰
            </label>
            <label class="checkbox-label">
              <input type="checkbox" id="trans-type-B" name="trans-types" value="B">
              Bï¼ˆè‹±æ¤œ2ç´šï¼‰
            </label>
            <label class="checkbox-label">
              <input type="checkbox" id="trans-type-C" name="trans-types" value="C">
              Cï¼ˆè‹±æ¤œæº–1ç´šï¼‰
            </label>
            <label class="checkbox-label">
              <input type="checkbox" id="trans-type-D" name="trans-types" value="D">
              Dï¼ˆè‹±æ¤œ1ç´šï¼‰
            </label>
            <label class="checkbox-label">
              <input type="checkbox" id="trans-type-E" name="trans-types" value="E">
              Eï¼ˆåˆ¥ã‚¢ãƒ—ãƒ­ãƒ¼ãƒç‰ˆï¼‰
            </label>
          </div>
        </div>

        <button class="btn-submit" onclick="submitEssay('translation')">âœï¸ æ·»å‰Šã™ã‚‹</button>
      </div>

      <!-- ã‚¿ãƒ–3: å›³è¡¨ä»˜ãè‹±ä½œæ–‡ -->
      <div class="essay-card tab-content" id="diagram-essay">
        <h3 class="essay-subheading">å›³è¡¨ä»˜ãè‹±ä½œæ–‡ AIæ·»å‰Š</h3>
        <div class="form-group">
          <label for="question-diagram">å•é¡Œæ–‡ï¼ˆãƒ†ãƒ¼ãƒãƒ»æŒ‡ç¤ºæ–‡ï¼‰</label>
          <textarea id="question-diagram" class="essay-textarea" rows="4"
            placeholder="ä¾‹: Describe the chart below in about 150 words."></textarea>
        </div>

        <div class="form-group">
          <label for="image-upload">å›³è¡¨ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</label>
          <div class="image-upload-area" id="image-upload-area" ondrop="handleDrop(event)" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
            <input type="file" id="image-upload" accept="image/*" onchange="handleImageSelect(event)" style="display: none;">
            <input type="file" id="camera-input" accept="image/*" capture="environment" style="display: none;">
            <div class="upload-placeholder">
              <p>ğŸ“¸ ã“ã“ã«ç”»åƒã‚’ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—</p>
              <p class="upload-hint">ã¾ãŸã¯ã€ä¸‹ã®ãƒœã‚¿ãƒ³ã‹ã‚‰é¸æŠã—ã¦ãã ã•ã„</p>
            </div>
            <div id="image-preview" class="image-preview" hidden></div>
          </div>
          <div class="upload-buttons">
            <button class="btn-upload" onclick="document.getElementById('image-upload').click()">ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</button>
            <button class="btn-upload" onclick="document.getElementById('camera-input').click()">ğŸ“· ã‚«ãƒ¡ãƒ©ã§æ’®å½±</button>
          </div>
        </div>

        <div class="form-group">
          <label for="answer-diagram">ã‚ãªãŸã®ä½œå“</label>
          <textarea id="answer-diagram" class="essay-textarea essay-textarea--answer" rows="10"
            placeholder="è‹±ä½œæ–‡ã‚’ã“ã“ã«å…¥åŠ›ã—ã¦ãã ã•ã„â€¦"></textarea>
        </div>

        <div class="form-group">
          <label>è§£ç­”ä¾‹ã‚¿ã‚¤ãƒ—ï¼ˆè¤‡æ•°é¸æŠå¯ï¼‰</label>
          <div class="checkbox-group">
            <label class="checkbox-label">
              <input type="checkbox" id="diagram-type-A" name="diagram-types" value="A" checked>
              Aï¼ˆåŸæ–‡ãƒ™ãƒ¼ã‚¹ï¼‰
            </label>
            <label class="checkbox-label">
              <input type="checkbox" id="diagram-type-B" name="diagram-types" value="B">
              Bï¼ˆè‹±æ¤œ2ç´šï¼‰
            </label>
            <label class="checkbox-label">
              <input type="checkbox" id="diagram-type-C" name="diagram-types" value="C">
              Cï¼ˆè‹±æ¤œæº–1ç´šï¼‰
            </label>
            <label class="checkbox-label">
              <input type="checkbox" id="diagram-type-D" name="diagram-types" value="D">
              Dï¼ˆè‹±æ¤œ1ç´šï¼‰
            </label>
            <label class="checkbox-label">
              <input type="checkbox" id="diagram-type-E" name="diagram-types" value="E">
              Eï¼ˆåˆ¥ã‚¢ãƒ—ãƒ­ãƒ¼ãƒç‰ˆï¼‰
            </label>
          </div>
        </div>

        <button class="btn-submit" onclick="submitEssay('diagram-essay')">âœï¸ æ·»å‰Šã™ã‚‹</button>
      </div>

      <div id="result-area" class="result-area" hidden>
        <h3 class="result-title">æ·»å‰Šçµæœï¼ˆã‚ã£ã¡ã‚ƒé•·ã„ğŸ˜‡ï¼‰</h3>
        <div id="result-content" class="result-content"></div>
      </div>
    </section>

    <section class="history-section" id="history-section" hidden>
      <div class="history-header">
        <h3 class="history-title">ğŸ“‹ éå»ã®æ·»å‰Šå±¥æ­´</h3>
        <button class="btn-hist-clear" onclick="clearAllHistory()">ã™ã¹ã¦å‰Šé™¤</button>
      </div>
      <div id="history-list" class="history-list"></div>
    </section>
  </main>

  <footer>
    <p>ğŸ§ Yossyã®ãƒšãƒ³ã‚®ãƒ³ã•ã„ã¨ &copy; Yossy</p>
  </footer>

  <script src="theme.js"></script>
  <script>
    // ===================================================
    // Cloudflare Worker ã®URLã‚’ã“ã“ã«è¨­å®šã—ã¦ãã ã•ã„
    // worker.js ã‚’ãƒ‡ãƒ—ãƒ­ã‚¤ã—ãŸå¾Œã€URLã‚’å·®ã—æ›¿ãˆã¦ãã ã•ã„
    // ===================================================
    const WORKER_URL = 'https://essay-proxy.yoshida-tom-ac.workers.dev';
    const TYPES_KEY = 'essay_types_selection';
    const CUSTOM_KEY = 'essay_custom_instruction';

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ï¼šã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸç”»åƒ
    let uploadedImageBase64 = null;

    // localStorage ã«ä¿å­˜ã•ã‚ŒãŸã‚¿ã‚¤ãƒ—ã‚’å¾©å…ƒ
    function loadSavedTypes() {
      try {
        const saved = localStorage.getItem(TYPES_KEY);
        return saved ? JSON.parse(saved) : ['A'];
      } catch {
        return ['A'];
      }
    }

    // ã‚¿ã‚¤ãƒ—é¸æŠã‚’ä¿å­˜
    function saveSelectedTypes() {
      const checkboxes = document.querySelectorAll('input[name="types"]:checked');
      const types = Array.from(checkboxes).map(cb => cb.value);
      if (types.length === 0) {
        // ä½•ã‚‚é¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆã¯ A ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã«
        localStorage.setItem(TYPES_KEY, JSON.stringify(['A']));
        document.getElementById('type-A').checked = true;
      } else {
        localStorage.setItem(TYPES_KEY, JSON.stringify(types));
      }
    }

    // åˆæœŸåŒ–ï¼šä¿å­˜ã•ã‚ŒãŸã‚¿ã‚¤ãƒ—ã‚’å¾©å…ƒ
    function restoreTypes() {
      const saved = loadSavedTypes();
      document.querySelectorAll('input[name="types"]').forEach(cb => {
        cb.checked = saved.includes(cb.value);
      });
    }

    // ä¿å­˜ã•ã‚ŒãŸ custom instruction ã‚’å¾©å…ƒ
    function loadCustomInstruction() {
      try {
        return localStorage.getItem(CUSTOM_KEY) || '';
      } catch {
        return '';
      }
    }

    // Custom instruction ã‚’ä¿å­˜
    function saveCustomInstruction() {
      const text = document.getElementById('custom-instruction').value.trim();
      localStorage.setItem(CUSTOM_KEY, text);
    }

    // Custom section ã‚’å±•é–‹/æŠ˜ç•³
    function toggleCustomSection() {
      const section = document.getElementById('custom-section');
      const toggleText = document.getElementById('custom-toggle-text');
      section.hidden = !section.hidden;
      toggleText.textContent = section.hidden ? 'â–¶ Fï¼šè§£ç­”ä¾‹ã‚’è©³ã—ãæŒ‡å®šã™ã‚‹' : 'â–¼ Fï¼šè§£ç­”ä¾‹ã‚’è©³ã—ãæŒ‡å®šã™ã‚‹';
    }

    // ===================================================
    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆæ©Ÿèƒ½
    // ===================================================
    function switchTab(tabId) {
      // ã™ã¹ã¦ã®ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éè¡¨ç¤º
      document.querySelectorAll('.tab-content').forEach(el => {
        el.classList.remove('tab-content--active');
      });

      // ã™ã¹ã¦ã®ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('tab-btn--active');
      });

      // é¸æŠã•ã‚ŒãŸã‚¿ãƒ–ã‚’è¡¨ç¤º
      document.getElementById(tabId).classList.add('tab-content--active');

      // é¸æŠã•ã‚ŒãŸã‚¿ãƒ–ãƒœã‚¿ãƒ³ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–
      document.querySelector(`[data-tab="${tabId}"]`).classList.add('tab-btn--active');
    }

    // ===================================================
    // ç”»åƒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½
    // ===================================================
    function handleDragOver(e) {
      e.preventDefault();
      e.stopPropagation();
      document.getElementById('image-upload-area').classList.add('drag-over');
    }

    function handleDragLeave(e) {
      e.preventDefault();
      e.stopPropagation();
      document.getElementById('image-upload-area').classList.remove('drag-over');
    }

    function handleDrop(e) {
      e.preventDefault();
      e.stopPropagation();
      document.getElementById('image-upload-area').classList.remove('drag-over');

      const files = e.dataTransfer.files;
      if (files.length > 0) {
        handleImageSelect({ target: { files } });
      }
    }

    function handleImageSelect(e) {
      const file = e.target.files[0];
      if (!file) return;

      // ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ãƒã‚§ãƒƒã‚¯
      if (!file.type.startsWith('image/')) {
        alert('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
        return;
      }

      // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãƒã‚§ãƒƒã‚¯ï¼ˆ10MBã¾ã§ï¼‰
      if (file.size > 10 * 1024 * 1024) {
        alert('ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã¯10MBä»¥ä¸‹ã«ã—ã¦ãã ã•ã„ã€‚');
        return;
      }

      const reader = new FileReader();
      reader.onload = function(event) {
        uploadedImageBase64 = event.target.result;
        displayImagePreview(file.name);
      };
      reader.readAsDataURL(file);
    }

    function displayImagePreview(fileName) {
      const preview = document.getElementById('image-preview');
      const placeholder = document.querySelector('.upload-placeholder');

      placeholder.style.display = 'none';
      preview.innerHTML = `
        <div class="image-preview-item">
          <img src="${uploadedImageBase64}" alt="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼">
          <p class="image-preview-name">${fileName}</p>
          <button class="btn-remove-image" onclick="removeImage()">å‰Šé™¤</button>
        </div>
      `;
      preview.hidden = false;
    }

    function removeImage() {
      uploadedImageBase64 = null;
      document.getElementById('image-upload').value = '';
      document.getElementById('camera-input').value = '';
      document.getElementById('image-preview').innerHTML = '';
      document.getElementById('image-preview').hidden = true;
      document.querySelector('.upload-placeholder').style.display = 'block';
    }

    // ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹å¤‰æ›´æ™‚ã«è‡ªå‹•ä¿å­˜
    document.addEventListener('DOMContentLoaded', function() {
      // ã‚¿ãƒ–ãƒœã‚¿ãƒ³ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¿½åŠ 
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          switchTab(this.dataset.tab);
        });
      });

      restoreTypes();
      document.querySelectorAll('input[name="types"]').forEach(cb => {
        cb.addEventListener('change', saveSelectedTypes);
      });
      // Custom instruction ã®å¾©å…ƒ
      document.getElementById('custom-instruction').value = loadCustomInstruction();
      document.getElementById('custom-instruction').addEventListener('change', saveCustomInstruction);
      document.getElementById('custom-instruction').addEventListener('blur', saveCustomInstruction);
    });

    async function submitEssay(tabType) {
      let payload = {};

      // ã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦ãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’æ§‹ç¯‰
      if (tabType === 'free-essay') {
        const question = document.getElementById('question-free').value.trim();
        const answer = document.getElementById('answer-free').value.trim();

        if (!answer) {
          alert('è§£ç­”ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
          return;
        }

        const checkboxes = document.querySelectorAll('input[name="types"]:checked');
        const types = Array.from(checkboxes).map(cb => cb.value);
        const customInstruction = document.getElementById('custom-instruction').value.trim();

        payload = {
          essayType: 'free-essay',
          question,
          answer,
          types,
          customInstruction
        };

      } else if (tabType === 'translation') {
        const japaneseText = document.getElementById('japanese-text').value.trim();
        const answer = document.getElementById('answer-translation').value.trim();

        if (!japaneseText || !answer) {
          alert('æ—¥æœ¬èªã¨è‹±è¨³ã®ä¸¡æ–¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
          return;
        }

        const transCheckboxes = document.querySelectorAll('input[name="trans-types"]:checked');
        const transTypes = Array.from(transCheckboxes).map(cb => cb.value);

        payload = {
          essayType: 'translation',
          japaneseText,
          answer,
          types: transTypes
        };

      } else if (tabType === 'diagram-essay') {
        const question = document.getElementById('question-diagram').value.trim();
        const answer = document.getElementById('answer-diagram').value.trim();

        if (!answer) {
          alert('è§£ç­”ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
          return;
        }

        if (!uploadedImageBase64) {
          alert('å›³è¡¨ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚');
          return;
        }

        const diagramCheckboxes = document.querySelectorAll('input[name="diagram-types"]:checked');
        const diagramTypes = Array.from(diagramCheckboxes).map(cb => cb.value);

        payload = {
          essayType: 'diagram-essay',
          question,
          answer,
          imageBase64: uploadedImageBase64,
          types: diagramTypes
        };
      }

      if (WORKER_URL.includes('YOUR_WORKER_NAME')) {
        alert('å…ˆç”ŸãŒã¾ã æ·»å‰Šæ©Ÿèƒ½ã®è¨­å®šã‚’å®Œäº†ã—ã¦ã„ã¾ã›ã‚“ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚');
        return;
      }

      // ã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦ãƒœã‚¿ãƒ³ã‚’ç‰¹å®š
      const allButtons = document.querySelectorAll('.btn-submit');
      let btn = allButtons[Array.from(allButtons).length - 1]; // æœ€å¾Œã®ãƒœã‚¿ãƒ³ã‚’ä½¿ã†ï¼ˆè¤‡é›‘ãªã®ã§æ”¹å–„ã®ä½™åœ°ã‚ã‚Šï¼‰
      const activeTab = document.querySelector('.tab-content--active');
      btn = activeTab.querySelector('.btn-submit');

      btn.disabled = true;
      btn.textContent = 'æ·»å‰Šä¸­â€¦';

      const resultArea = document.getElementById('result-area');
      const resultContent = document.getElementById('result-content');
      resultContent.innerHTML = '';
      resultArea.hidden = false;
      resultArea.scrollIntoView({ behavior: 'smooth' });

      try {
        console.log('[Essay] Sending request:', payload);

        const res = await fetch(WORKER_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });

        console.log('[Essay] Response status:', res.status, 'Content-Type:', res.headers.get('content-type'));

        if (!res.ok) {
          const msg = await res.text();
          console.error('[Essay] Error response:', msg);
          throw new Error(`ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ (${res.status}): ${msg}`);
        }

        // SSE ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’é€æ¬¡èª­ã¿å–ã‚Šã€ãƒ†ã‚­ã‚¹ãƒˆãŒå±ŠããŸã³ã«æç”»ã™ã‚‹
        const reader = res.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';
        let fullText = '';
        let eventCount = 0;

        while (true) {
          const { done, value } = await reader.read();
          if (done) {
            console.log('[Essay] Stream complete. Total events:', eventCount, 'Text length:', fullText.length);
            break;
          }

          buffer += decoder.decode(value, { stream: true });
          const lines = buffer.split('\n');
          buffer = lines.pop();

          for (const line of lines) {
            if (!line.startsWith('data: ')) continue;
            const raw = line.slice(6).trim();
            if (!raw) continue;
            try {
              const evt = JSON.parse(raw);
              console.log('[Essay] Event type:', evt.type);
              if (evt.type === 'content_block_delta' && evt.delta?.type === 'text_delta') {
                fullText += evt.delta.text;
                eventCount++;
                resultContent.innerHTML = renderMarkdown(fullText);
              } else if (evt.type === 'message_start' || evt.type === 'message_stop' || evt.type === 'content_block_start') {
                console.log('[Essay] Metadata event:', evt.type);
              }
            } catch (parseErr) {
              console.warn('[Essay] JSON parse error:', raw.slice(0, 100), parseErr.message);
            }
          }
        }

        if (!fullText) {
          resultContent.innerHTML = '<p>ã‚¨ãƒ©ãƒ¼ï¼šã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æ·»å‰Šçµæœã‚’å—ã‘å–ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>';
          console.error('[Essay] No text received. Check Worker logs and API response.');
        } else {
          saveToHistory(tabType, payload, fullText);
        }

      } catch (err) {
        resultArea.hidden = true;
        console.error('[Essay] Exception:', err);
        alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:\n' + err.message + '\n\nãƒ–ãƒ©ã‚¦ã‚¶ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ï¼ˆF12ï¼‰ã§è©³ç´°ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
      } finally {
        btn.disabled = false;
        btn.textContent = 'âœï¸ æ·»å‰Šã™ã‚‹';
      }
    }

    function escapeHtml(s) {
      return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    function formatInline(s) {
      return s
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        .replace(/`(.+?)`/g, '<code>$1</code>');
    }

    function renderMarkdown(text) {
      if (typeof text !== 'string') return '<p>ï¼ˆæ·»å‰Šçµæœã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸï¼‰</p>';
      const lines = text.split('\n');
      let html   = '';
      let inList = false;

      for (const line of lines) {
        if (line.startsWith('## ')) {
          if (inList) { html += '</ul>'; inList = false; }
          html += `<h3 class="r-h3">${formatInline(escapeHtml(line.slice(3)))}</h3>`;
        } else if (line.startsWith('### ')) {
          if (inList) { html += '</ul>'; inList = false; }
          html += `<h4 class="r-h4">${formatInline(escapeHtml(line.slice(4)))}</h4>`;
        } else if (/^[-*] /.test(line)) {
          if (!inList) { html += '<ul class="r-list">'; inList = true; }
          html += `<li>${formatInline(escapeHtml(line.slice(2)))}</li>`;
        } else if (line.trim() === '') {
          if (inList) { html += '</ul>'; inList = false; }
        } else {
          if (inList) { html += '</ul>'; inList = false; }
          html += `<p class="r-p">${formatInline(escapeHtml(line))}</p>`;
        }
      }

      if (inList) html += '</ul>';
      return html;
    }

    // ===================================================
    // æ·»å‰Šå±¥æ­´ (localStorage)
    // ===================================================
    const HIST_KEY = 'essay_history';
    const MAX_HIST = 20;

    function loadHistories() {
      try { return JSON.parse(localStorage.getItem(HIST_KEY)) || []; }
      catch { return []; }
    }

    function saveToHistory(essayType, payload, correction) {
      const list = loadHistories();
      const historyItem = {
        id: Date.now(),
        date: new Date().toISOString(),
        essayType,
        payload,
        correction
      };
      list.unshift(historyItem);
      if (list.length > MAX_HIST) list.length = MAX_HIST;
      localStorage.setItem(HIST_KEY, JSON.stringify(list));
      renderHistoryList();
    }

    function renderHistoryList() {
      const list = loadHistories();
      const section = document.getElementById('history-section');
      const container = document.getElementById('history-list');
      if (list.length === 0) { section.hidden = true; return; }
      section.hidden = false;
      container.innerHTML = list.map(h => {
        const d = new Date(h.date);
        const pad = n => String(n).padStart(2, '0');
        const dateStr = `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;

        // ã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ç”Ÿæˆ
        let preview = 'ï¼ˆæƒ…å ±ãªã—ï¼‰';
        let answerPreview = 'ï¼ˆæƒ…å ±ãªã—ï¼‰';

        if (h.essayType === 'free-essay') {
          preview = h.payload.question ? escapeHtml(h.payload.question.slice(0, 45)) + (h.payload.question.length > 45 ? 'â€¦' : '') : 'ï¼ˆå•é¡Œæ–‡ãªã—ï¼‰';
          answerPreview = h.payload.answer ? escapeHtml(h.payload.answer.slice(0, 80)) + (h.payload.answer.length > 80 ? 'â€¦' : '') : 'ï¼ˆè§£ç­”ãªã—ï¼‰';
        } else if (h.essayType === 'translation') {
          preview = h.payload.japaneseText ? escapeHtml(h.payload.japaneseText.slice(0, 45)) + (h.payload.japaneseText.length > 45 ? 'â€¦' : '') : 'ï¼ˆæ—¥æœ¬èªãªã—ï¼‰';
          answerPreview = h.payload.answer ? escapeHtml(h.payload.answer.slice(0, 80)) + (h.payload.answer.length > 80 ? 'â€¦' : '') : 'ï¼ˆè‹±è¨³ãªã—ï¼‰';
        } else if (h.essayType === 'diagram-essay') {
          preview = h.payload.question ? escapeHtml(h.payload.question.slice(0, 45)) + (h.payload.question.length > 45 ? 'â€¦' : '') : 'ï¼ˆå•é¡Œæ–‡ãªã—ï¼‰';
          answerPreview = h.payload.answer ? escapeHtml(h.payload.answer.slice(0, 80)) + (h.payload.answer.length > 80 ? 'â€¦' : '') : 'ï¼ˆè§£ç­”ãªã—ï¼‰';
        }

        // ã‚¿ã‚¤ãƒ—ãƒ©ãƒ™ãƒ«
        const typeLabel = {
          'free-essay': 'ãµã¤ã†ã®è‹±ä½œæ–‡',
          'translation': 'å’Œæ–‡è‹±è¨³',
          'diagram-essay': 'å›³è¡¨ä»˜ãè‹±ä½œæ–‡'
        }[h.essayType] || 'ãã®ä»–';

        return `
          <div class="history-item" id="hist-${h.id}">
            <div class="history-item-row">
              <div class="history-item-meta">
                <span class="history-date">${dateStr}</span>
                <span class="history-type-badge">${typeLabel}</span>
                <span class="history-preview">${preview}</span>
              </div>
              <div class="history-item-actions">
                <button class="btn-hist-view" onclick="toggleHistoryItem(${h.id})">è¡¨ç¤º</button>
                <button class="btn-hist-del" onclick="deleteHistoryItem(${h.id})">å‰Šé™¤</button>
              </div>
            </div>
            <div class="history-item-body" id="hist-body-${h.id}" hidden>
              <p class="history-answer-preview"><strong>è§£ç­”ï¼š</strong>${answerPreview}</p>
              <div class="result-content">${renderMarkdown(h.correction)}</div>
            </div>
          </div>`;
      }).join('');
    }

    function toggleHistoryItem(id) {
      const body = document.getElementById(`hist-body-${id}`);
      const btn  = document.querySelector(`#hist-${id} .btn-hist-view`);
      body.hidden = !body.hidden;
      btn.textContent = body.hidden ? 'è¡¨ç¤º' : 'é–‰ã˜ã‚‹';
    }

    function deleteHistoryItem(id) {
      const list = loadHistories().filter(h => h.id !== id);
      localStorage.setItem(HIST_KEY, JSON.stringify(list));
      renderHistoryList();
    }

    function clearAllHistory() {
      if (!confirm('ã™ã¹ã¦ã®å±¥æ­´ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
      localStorage.removeItem(HIST_KEY);
      renderHistoryList();
    }

    // åˆæœŸæç”»
    renderHistoryList();
  </script>

</body>
</html>
